<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ê†∏ÂøÉÈò≤Âæ° - Ê∏∏ÊàèËøõË°å‰∏≠</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;  /* ÊîπÂõûÈªëËâ≤ */
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: Arial, sans-serif;
            cursor: none; /* ÈöêËóèÂÖâÊ†á */
            touch-action: none; /* Èò≤Ê≠¢ÁßªÂä®Á´ØÈªòËÆ§Ëß¶Êë∏Ë°å‰∏∫ */
        }

        #gameCanvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
            cursor: none; /* Á°Æ‰øùÁîªÂ∏É‰∏ä‰πüÈöêËóèÂÖâÊ†á */
        }

        #infoPanel {
            position: absolute;
            top: 0;
            right: 0;
            width: 300px;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 20px;
            box-sizing: border-box;
            z-index: 2;
            display: flex;
            flex-direction: column;
            gap: 20px;
            cursor: default;
            overflow-y: auto;
        }

        .panel-section {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .panel-section:last-child {
            margin-bottom: 0;
        }

        .panel-section h2 {
            margin: 0 0 10px 0;
            font-size: 18px;
            color: #4CAF50;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            font-size: 14px;
        }

        .power-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 5px 0;
            font-size: 14px;
            justify-content: space-between;
        }

        .power-status-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .power-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .active {
            background: #4CAF50;
        }

        .cooldown {
            background: #FFA500;
        }

        .ready {
            background: #fff;
        }

        .projectile-score {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 5px 0;
            font-size: 14px;
        }

        .projectile-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .controls {
            margin-top: auto;
            font-size: 14px;
            color: #aaa;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
        }

        .controls p {
            margin: 5px 0;
            font-size: 14px;
        }

        #shieldCooldown, #freezeCooldown, #doubleCooldown, #invincibleCooldown,
        #redScore, #greenScore, #blueScore, #yellowScore, #purpleScore, #blackScore,
        #scoreChangeTimer {
            font-size: 14px;
        }

        #bgToggle {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 3;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            border: 1px solid #4CAF50;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer; /* ÊåâÈíÆÊòæÁ§∫ÊåáÈíàÂÖâÊ†á */
            font-size: 14px;
            transition: all 0.3s ease;
        }

        #inertiaToggle {
            position: absolute;
            bottom: 20px;
            left: 160px;
            z-index: 3;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            border: 1px solid #4CAF50;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        #colorToggle {
            position: absolute;
            bottom: 20px;
            left: 300px;
            z-index: 3;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            border: 1px solid #4CAF50;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        #bgToggle:hover, #inertiaToggle:hover, #colorToggle:hover {
            background: rgba(76, 175, 80, 0.2);
        }

        #bgToggle.active, #inertiaToggle.active, #colorToggle.active {
            background: rgba(76, 175, 80, 0.4);
        }

        #effectsPanel {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 3;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 15px;
            border-radius: 5px;
            font-size: 14px;
            display: none;
        }

        .effect-item {
            margin: 5px 0;
            padding: 5px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.1);
        }

        .effect-item.active {
            background: rgba(76, 175, 80, 0.3);
            animation: glow 1s infinite;
        }

        /* Èü≥‰πêÊéßÂà∂ÊåâÈíÆÊ†∑Âºè */
        #musicToggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            border: 1px solid #4CAF50;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        #musicToggle:hover {
            background: rgba(76, 175, 80, 0.2);
        }

        #musicToggle.active {
            background: rgba(76, 175, 80, 0.4);
        }

        #musicToggle::before {
            content: 'üîä';
            font-size: 20px;
        }

        #musicToggle.muted::before {
            content: 'üîá';
        }

        @keyframes glow {
            0% { box-shadow: 0 0 5px rgba(76, 175, 80, 0.5); }
            50% { box-shadow: 0 0 20px rgba(76, 175, 80, 0.8); }
            100% { box-shadow: 0 0 5px rgba(76, 175, 80, 0.5); }
        }

        /* ÁßªÂä®Á´ØÈÄÇÈÖç */
        @media (max-width: 768px) {
            #infoPanel {
                width: 100%;
                height: auto;
                position: fixed;
                bottom: 0;
                top: auto;
                padding: 10px;
                font-size: 12px;
            }

            .panel-section {
                padding: 8px;
                margin-bottom: 5px;
            }

            .panel-section h2 {
                font-size: 14px;
                margin: 0 0 5px 0;
            }

            .info-item, .power-status, .projectile-score {
                font-size: 12px;
                margin: 3px 0;
            }

            #gameCanvas {
                width: 100%;
                height: 100%;
            }

            #bgToggle, #inertiaToggle, #colorToggle, #autoAvoid {
                padding: 8px 15px;
                font-size: 12px;
                bottom: 10px;
            }

            #bgToggle { left: 10px; }
            #inertiaToggle { left: 120px; }
            #colorToggle { left: 230px; }
            #autoAvoid { left: 340px; }
        }

        /* ËôöÊãüÊëáÊùÜÊ†∑Âºè */
        #virtualJoystick {
            position: fixed;
            bottom: 100px;
            left: 50px;
            width: 100px;
            height: 100px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: none;
            z-index: 1000;
            touch-action: none;
        }

        #joystickKnob {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            touch-action: none;
        }

        /* ÁßªÂä®Á´ØÊéßÂà∂ÊåâÈíÆÊ†∑Âºè */
        .mobile-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: none;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }

        .mobile-button {
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
        }

        .mobile-button:active {
            background: rgba(255, 255, 255, 0.4);
        }

        /* ÁßªÂä®Á´ØÂäüËÉΩÊåâÈíÆ */
        .mobile-functions {
            position: fixed;
            bottom: 20px;
            left: 20px;
            display: none;
            gap: 10px;
            z-index: 1000;
        }

        .function-button {
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            border: 1px solid #4CAF50;
            border-radius: 5px;
            font-size: 14px;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
        }

        .function-button:active {
            background: rgba(76, 175, 80, 0.4);
        }

        /* ÁßªÂä®Á´ØÊ∏∏ÊàèÊéßÂà∂ÊåâÈíÆ */
        .mobile-game-controls {
            position: fixed;
            top: 20px;
            left: 20px;
            display: none;
            gap: 10px;
            z-index: 1000;
        }

        .game-control-button {
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            border: 1px solid #ff4444;
            border-radius: 5px;
            font-size: 14px;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
        }

        .game-control-button:active {
            background: rgba(255, 68, 68, 0.4);
        }

        @media (max-width: 768px) {
            .mobile-controls, .mobile-functions, .mobile-game-controls {
                display: flex;
            }

            #infoPanel {
                width: 100%;
                height: auto;
                position: fixed;
                bottom: 100px;
                top: auto;
                padding: 10px;
                font-size: 12px;
            }

            #bgToggle, #inertiaToggle, #colorToggle {
                display: none;
            }
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    
    <!-- Ê∑ªÂä†ËôöÊãüÊëáÊùÜ -->
    <div id="virtualJoystick">
        <div id="joystickKnob"></div>
    </div>

    <!-- ÁßªÂä®Á´ØÊéßÂà∂ÊåâÈíÆ -->
    <div class="mobile-controls">
        <button class="mobile-button" id="shieldButton">üõ°Ô∏è</button>
        <button class="mobile-button" id="freezeButton">‚ùÑÔ∏è</button>
        <button class="mobile-button" id="doubleButton">2x</button>
        <button class="mobile-button" id="invincibleButton">üí´</button>
    </div>

    <!-- ÁßªÂä®Á´ØÂäüËÉΩÊåâÈíÆ -->
    <div class="mobile-functions">
        <button class="function-button" id="bgToggleMobile">ÂàáÊç¢ËÉåÊôØ</button>
        <button class="function-button" id="inertiaToggleMobile">ÊÉØÊÄß</button>
        <button class="function-button" id="colorToggleMobile">ÂèòËâ≤</button>
    </div>

    <!-- ÁßªÂä®Á´ØÊ∏∏ÊàèÊéßÂà∂ÊåâÈíÆ -->
    <div class="mobile-game-controls">
        <button class="game-control-button" id="restartButton">ÈáçÊñ∞ÂºÄÂßã</button>
        <button class="game-control-button" id="exitButton">ÈÄÄÂá∫Ê∏∏Êàè</button>
    </div>

    <!-- Ê∑ªÂä†Èü≥‰πêÊéßÂà∂ÊåâÈíÆ -->
    <button id="musicToggle" class="active"></button>
    
    <button id="bgToggle">ÂàáÊç¢ËÉåÊôØ</button>
    <button id="inertiaToggle">ÊÉØÊÄß</button>
    <button id="colorToggle">ÂèòËâ≤</button>
    
    <div id="infoPanel">
        <div class="panel-section">
            <h2>Ê∏∏Êàè‰ø°ÊÅØ</h2>
            <div class="info-item">
                <span>Áé©ÂÆ∂Ôºö</span>
                <span id="playerNickname">Áé©ÂÆ∂</span>
            </div>
            <div class="info-item">
                <span>ÂàÜÊï∞Ôºö</span>
                <span id="score">0</span>
            </div>
            <div class="info-item">
                <span>ÁîüÂëΩÂÄºÔºö</span>
                <span id="health">100</span>
            </div>
            <div class="info-item">
                <span>Ê∏∏ÊàèÈÄüÂ∫¶Ôºö</span>
                <span id="speed">1.0x</span>
            </div>
            <div class="info-item">
                <span>Ê∏∏ÊàèÊó∂Èó¥Ôºö</span>
                <span id="time">0.0</span>
            </div>
        </div>

        <div class="panel-section">
            <h2>ÈÅìÂÖ∑Áä∂ÊÄÅ</h2>
            <div class="power-status">
                <div class="power-status-left">
                    <div class="power-indicator" id="shieldStatus"></div>
                    <span>Êä§Áõæ (Á©∫Ê†ºÈîÆ)</span>
                </div>
                <span id="shieldCooldown"></span>
            </div>
            <div class="power-status">
                <div class="power-status-left">
                    <div class="power-indicator" id="freezeStatus"></div>
                    <span>ÂÜªÁªì (FÈîÆ)</span>
                </div>
                <span id="freezeCooldown"></span>
            </div>
            <div class="power-status">
                <div class="power-status-left">
                    <div class="power-indicator" id="doubleStatus"></div>
                    <span>ÂèåÂÄçÂàÜÊï∞ (DÈîÆ)</span>
                </div>
                <span id="doubleCooldown"></span>
            </div>
            <div class="power-status">
                <div class="power-status-left">
                    <div class="power-indicator" id="invincibleStatus"></div>
                    <span>Êó†Êïå (IÈîÆ)</span>
                </div>
                <span id="invincibleCooldown"></span>
            </div>
        </div>

        <div class="panel-section">
            <h2>ÊäïÂ∞ÑÁâ©ÂàÜÊï∞</h2>
            <div class="projectile-score">
                <div class="projectile-dot" style="background: #ff0000"></div>
                <span>Á∫¢Ëâ≤Ôºö</span>
                <span id="redScore">-10</span>
            </div>
            <div class="projectile-score">
                <div class="projectile-dot" style="background: #00ff00"></div>
                <span>ÁªøËâ≤Ôºö</span>
                <span id="greenScore">5</span>
            </div>
            <div class="projectile-score">
                <div class="projectile-dot" style="background: #0000ff"></div>
                <span>ËìùËâ≤Ôºö</span>
                <span id="blueScore">8</span>
            </div>
            <div class="projectile-score">
                <div class="projectile-dot" style="background: #ffff00"></div>
                <span>ÈªÑËâ≤Ôºö</span>
                <span id="yellowScore">3</span>
            </div>
            <div class="projectile-score">
                <div class="projectile-dot" style="background: #800080"></div>
                <span>Á¥´Ëâ≤Ôºö</span>
                <span id="purpleScore">-6</span>
            </div>
            <div class="projectile-score">
                <div class="projectile-dot" style="background: #000000"></div>
                <span>ÈªëËâ≤Ôºö</span>
                <span id="blackScore">0</span>
            </div>
            <div class="info-item">
                <span>ÂàÜÊï∞ÂèòÂåñÂÄíËÆ°Êó∂Ôºö</span>
                <span id="scoreChangeTimer">15.0s</span>
            </div>
        </div>

        <div class="controls">
            <p>ESC - ËøîÂõûÁªìÁÆóÈ°µÈù¢</p>
            <p>Q - ËøîÂõûÊ®°ÂºèÈÄâÊã©</p>
            <p>R - ÈáçÊñ∞ÂºÄÂßã</p>
        </div>
    </div>

    <div id="effectsPanel">
        <div class="effect-item" id="effectSensitive">ÁÅµÊïè: 0/10</div>
        <div class="effect-item" id="effectPrecise">Á≤æÂáÜ: 0/20</div>
        <div class="effect-item" id="effectFocused">ÈõÜ‰∏≠Ê≥®ÊÑè: 0/30</div>
    </div>

    <script>
        // Ê∏∏Êàè‰∏ªÈÄªËæë‰ª£Á†Å
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // Ê∏∏ÊàèÁä∂ÊÄÅ
        let gameState = {
            score: 0,
            health: 100,
            speed: 1.0,
            time: 0,
            projectiles: [],
            cores: [],
            powers: {
                shield: { active: false, cooldown: 0, uses: 3 },
                freeze: { active: false, cooldown: 0, uses: 3 },
                double: { active: false, cooldown: 0, uses: 3 },
                invincible: { active: false, cooldown: 0, uses: 3 }
            },
            projectileScores: {
                red: -10,
                green: 5,
                blue: 8,
                yellow: 3,
                purple: -6,
                black: 0
            },
            mouseX: 0,
            mouseY: 0,
            lastProjectileTime: 0,
            projectileInterval: 1000,
            lastScoreChangeTime: 0,
            scoreChangeInterval: 15000,
            lastSpeedIncreaseTime: 0,
            speedIncreaseInterval: 10000,
            isGameRunning: false,
            backgroundImage: new Image(),
            useCustomBg: true,
            lastFrameTime: 0,
            coreSmoothing: 0.15,
            inertiaEnabled: true,
            colorMode: false, // Ê∑ªÂä†ÂèòËâ≤Ê®°ÂºèÁä∂ÊÄÅ
            effects: {
                redDodgeCount: 0,
                consecutiveScore: 0,
                negativeScoreTotal: 0,
                lastPositiveScore: 0,
                effects: []
            },
            minProjectiles: 15,
            maxProjectiles: 40
        };

        // ËÆæÁΩÆÁîªÂ∏ÉÂ§ßÂ∞è
        function resizeCanvas() {
            const isMobile = isMobileDevice();
            if (isMobile) {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            } else {
                canvas.width = window.innerWidth - 300;
                canvas.height = window.innerHeight;
            }
        }

        // Ê∑ªÂä†Èº†Ê†áÁßªÂä®‰∫ã‰ª∂ÁõëÂê¨Âô®
        function setupEventListeners() {
            canvas.addEventListener('mousemove', function(e) {
                const rect = canvas.getBoundingClientRect();
                gameState.mouseX = e.clientX - rect.left;
                gameState.mouseY = e.clientY - rect.top;
            });

            // Ê∑ªÂä†ËÉåÊôØÂàáÊç¢ÊåâÈíÆ‰∫ã‰ª∂ÁõëÂê¨
            document.getElementById('bgToggle').addEventListener('click', function() {
                gameState.useCustomBg = !gameState.useCustomBg;
                this.classList.toggle('active');
                this.textContent = gameState.useCustomBg ? 'ÂàáÊç¢ËÉåÊôØ' : 'ÊÅ¢Â§çÁÅ∞Ëâ≤';
            });

            // Ê∑ªÂä†ÊÉØÊÄßÂàáÊç¢ÊåâÈíÆ‰∫ã‰ª∂ÁõëÂê¨
            document.getElementById('inertiaToggle').addEventListener('click', function() {
                gameState.inertiaEnabled = !gameState.inertiaEnabled;
                this.classList.toggle('active');
                this.textContent = gameState.inertiaEnabled ? 'ÊÉØÊÄß' : 'Êó†ÊÉØÊÄß';
                gameState.coreSmoothing = gameState.inertiaEnabled ? 0.15 : 1;
            });

            // Ê∑ªÂä†ÂèòËâ≤ÊåâÈíÆ‰∫ã‰ª∂ÁõëÂê¨
            document.getElementById('colorToggle').addEventListener('click', function() {
                gameState.colorMode = !gameState.colorMode;
                this.classList.toggle('active');
                this.textContent = gameState.colorMode ? 'ÊÅ¢Â§çÂéüËâ≤' : 'ÂèòËâ≤';
            });

            document.addEventListener('keydown', function(e) {
                if (!gameState.isGameRunning) return;
                
                switch(e.key.toLowerCase()) {
                    case ' ': // Á©∫Ê†ºÈîÆ - Êä§Áõæ
                        e.preventDefault(); // ÈòªÊ≠¢Á©∫Ê†ºÈîÆÁöÑÈªòËÆ§Ë°å‰∏∫
                        if (gameState.powers.shield.uses > 0 && gameState.powers.shield.cooldown <= 0) {
                            activateShield();
                        }
                        break;
                    case 'f': // FÈîÆ - ÂÜªÁªì
                        if (gameState.powers.freeze.uses > 0 && gameState.powers.freeze.cooldown <= 0) {
                            activateFreeze();
                        }
                        break;
                    case 'd': // DÈîÆ - ÂèåÂÄçÂàÜÊï∞
                        if (gameState.powers.double.uses > 0 && gameState.powers.double.cooldown <= 0) {
                            activateDoubleScore();
                        }
                        break;
                    case 'i': // IÈîÆ - Êó†Êïå
                        if (gameState.powers.invincible.uses > 0 && gameState.powers.invincible.cooldown <= 0) {
                            activateInvincible();
                        }
                        break;
                    case 'escape': // ESCÈîÆ - ËøîÂõûÁªìÁÆóÈ°µÈù¢
                        e.preventDefault(); // ÈòªÊ≠¢ÈªòËÆ§Ë°å‰∏∫
                        endGame();
                        break;
                    case 'q': // QÈîÆ - ËøîÂõûÊ®°ÂºèÈÄâÊã©
                        gameState.isGameRunning = false;
                        window.location.href = 'Start.html';
                        break;
                    case 'r': // RÈîÆ - ÈáçÊñ∞ÂºÄÂßã
                        gameState.isGameRunning = false;
                        window.location.reload();
                        break;
                }
            });
        }

        // ÂàùÂßãÂåñÊ∏∏Êàè
        function initGame() {
            console.log('Initializing game...');
            const mode = localStorage.getItem('gameMode') || 'EASY';
            const nickname = localStorage.getItem('playerNickname') || 'Áé©ÂÆ∂';
            
            // ÊòæÁ§∫Áé©ÂÆ∂ÊòµÁß∞
            document.getElementById('playerNickname').textContent = nickname;
            
            // Âä†ËΩΩËÉåÊôØÂõæÁâá
            gameState.backgroundImage.src = 'BG.png';
            
            // Á°Æ‰øùÁîªÂ∏ÉÂ∞∫ÂØ∏Â∑≤Êõ¥Êñ∞
            resizeCanvas();
            
            // Ê†πÊçÆÊ®°ÂºèËÆæÁΩÆÊ†∏ÂøÉÂíåÂèòËâ≤Êó∂Èó¥Èó¥Èöî
            switch(mode) {
                case 'EASY':
                    gameState.cores = [{
                        x: canvas.width / 2,
                        y: canvas.height / 2,
                        size: 20,
                        nickname: nickname,
                        targetX: canvas.width / 2,
                        targetY: canvas.height / 2
                    }];
                    gameState.scoreChangeInterval = 60000; // 60Áßí
                    break;
                case 'MEDIUM':
                    gameState.cores = [
                        {
                            x: canvas.width / 3,
                            y: canvas.height / 2,
                            size: 20,
                            nickname: nickname,
                            targetX: canvas.width / 3,
                            targetY: canvas.height / 2
                        },
                        {
                            x: (canvas.width * 2) / 3,
                            y: canvas.height / 2,
                            size: 20,
                            nickname: nickname,
                            targetX: (canvas.width * 2) / 3,
                            targetY: canvas.height / 2
                        }
                    ];
                    gameState.scoreChangeInterval = 30000; // 30Áßí
                    break;
                case 'HARD':
                    gameState.cores = [
                        {
                            x: canvas.width / 2,
                            y: canvas.height / 3,
                            size: 20,
                            nickname: nickname,
                            targetX: canvas.width / 2,
                            targetY: canvas.height / 3
                        },
                        {
                            x: canvas.width / 3,
                            y: (canvas.height * 2) / 3,
                            size: 20,
                            nickname: nickname,
                            targetX: canvas.width / 3,
                            targetY: (canvas.height * 2) / 3
                        },
                        {
                            x: (canvas.width * 2) / 3,
                            y: (canvas.height * 2) / 3,
                            size: 20,
                            nickname: nickname,
                            targetX: (canvas.width * 2) / 3,
                            targetY: (canvas.height * 2) / 3
                        }
                    ];
                    gameState.scoreChangeInterval = 10000; // 10Áßí
                    break;
            }

            // ÈáçÁΩÆÊ∏∏ÊàèÁä∂ÊÄÅ
            gameState.score = 0;
            gameState.health = 100;
            gameState.speed = 1.0;
            gameState.time = 0;
            gameState.projectiles = [];
            gameState.powers = {
                shield: { active: false, cooldown: 0, uses: 3 },
                freeze: { active: false, cooldown: 0, uses: 3 },
                double: { active: false, cooldown: 0, uses: 3 },
                invincible: { active: false, cooldown: 0, uses: 3 }
            };
            gameState.lastProjectileTime = 0;
            gameState.lastScoreChangeTime = 0;
            gameState.lastSpeedIncreaseTime = 0;
            gameState.isGameRunning = true;

            // ÂàùÂßãÂåñÈº†Ê†á‰ΩçÁΩÆ‰∏∫‰∏≠ÂøÉÁÇπ
            gameState.mouseX = canvas.width / 2;
            gameState.mouseY = canvas.height / 2;

            // ËÆæÁΩÆÊäïÂ∞Ñ‰ΩìÂèÇÊï∞
            gameState.minProjectiles = 15; // ÊúÄÂ∞èÊäïÂ∞Ñ‰ΩìÊï∞Èáè
            gameState.maxProjectiles = 40; // ÊúÄÂ§ßÊäïÂ∞Ñ‰ΩìÊï∞Èáè
            gameState.projectileInterval = 500; // Âü∫Á°ÄÁîüÊàêÈó¥ÈöîÔºàÊØ´ÁßíÔºâ

            // ÂàùÂßãÁîüÊàê‰∏Ä‰∫õÊäïÂ∞Ñ‰Ωì
            for (let i = 0; i < gameState.minProjectiles; i++) {
                generateProjectile();
            }

            // ËÆæÁΩÆÁßªÂä®Á´ØÊéßÂà∂
            if (isMobileDevice()) {
                setupMobileControls();
            }

            console.log('Game initialized, starting game loop...');
            // ÂêØÂä®Ê∏∏ÊàèÂæ™ÁéØ
            requestAnimationFrame(gameLoop);
        }

        // ÁîüÊàêÊäïÂ∞Ñ‰Ωì
        function generateProjectile() {
            const now = Date.now();
            if (now - gameState.lastProjectileTime < gameState.projectileInterval) {
                return;
            }
            gameState.lastProjectileTime = now;

            // Â¶ÇÊûúÂΩìÂâçÊäïÂ∞Ñ‰ΩìÊï∞ÈáèÂ∑≤ÁªèËææÂà∞‰∏äÈôêÔºåÁßªÈô§ÊúÄÊó©ÁöÑ‰∏Ä‰∏™
            if (gameState.projectiles.length >= gameState.maxProjectiles) {
                gameState.projectiles.shift();
            }

            // ÈöèÊú∫ÈÄâÊã©ÁîüÊàê‰ΩçÁΩÆÔºàÂ±èÂπïÂõõËæπÔºâ
            const side = Math.floor(Math.random() * 4);
            let x, y;

            // Ê†πÊçÆËæπÁîüÊàê‰ΩçÁΩÆ
            switch(side) {
                case 0: // ‰∏äËæπ
                    x = Math.random() * canvas.width;
                    y = 0;
                    break;
                case 1: // Âè≥Ëæπ
                    x = canvas.width;
                    y = Math.random() * canvas.height;
                    break;
                case 2: // ‰∏ãËæπ
                    x = Math.random() * canvas.width;
                    y = canvas.height;
                    break;
                case 3: // Â∑¶Ëæπ
                    x = 0;
                    y = Math.random() * canvas.height;
                    break;
            }

            // ÈÄâÊã©ÁõÆÊ†áÊ†∏ÂøÉÔºàÊúÄËøëÊàñÊúÄËøúÔºâ
            const targetType = Math.random() < 0.5 ? 'nearest' : 'furthest';
            let targetCore;
            let minDist = Infinity;
            let maxDist = 0;
            
            gameState.cores.forEach(core => {
                const dist = Math.sqrt(
                    Math.pow(core.x - x, 2) + 
                    Math.pow(core.y - y, 2)
                );
                if (targetType === 'nearest' && dist < minDist) {
                    minDist = dist;
                    targetCore = core;
                } else if (targetType === 'furthest' && dist > maxDist) {
                    maxDist = dist;
                    targetCore = core;
                }
            });

            // ËÆ°ÁÆóÊñπÂêë
            const dx = targetCore.x - x;
            const dy = targetCore.y - y;
            const length = Math.sqrt(dx * dx + dy * dy);
            const speed = gameState.speed;

            // ÈöèÊú∫ÈÄâÊã©È¢úËâ≤
            const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#800080', '#000000'];
            const color = gameState.colorMode ? '#00ff00' : colors[Math.floor(Math.random() * colors.length)];

            // ÂàõÂª∫ÊäïÂ∞Ñ‰Ωì
            const projectile = {
                x: x,
                y: y,
                dx: (dx / length) * speed,
                dy: (dy / length) * speed,
                color: color,
                size: 5,
                originalColor: color,
                creationTime: now,
                changeColorTime: Math.random() * 5000 + 2000 // 2-7ÁßíÂêéÂèòËâ≤
            };

            // 30%Ê¶ÇÁéáÂèëÁîüË£ÇÂèò
            if (Math.random() < 0.3) {
                projectile.willSplit = true;
                projectile.splitTime = Math.random() * 2000 + 1000; // 1-3ÁßíÂêéË£ÇÂèò
            }

            gameState.projectiles.push(projectile);
        }

        // Ê∏∏Êàè‰∏ªÂæ™ÁéØ
        function gameLoop(timestamp) {
            if (!gameState.isGameRunning) return;
            
            // ËÆ°ÁÆóÂ∏ßÈó¥ÈöîÊó∂Èó¥ÔºàÁßíÔºâ
            if (!gameState.lastFrameTime) {
                gameState.lastFrameTime = timestamp;
            }
            const deltaTime = (timestamp - gameState.lastFrameTime) / 1000; // ËΩ¨Êç¢‰∏∫Áßí
            gameState.lastFrameTime = timestamp;
            
            updateGame(deltaTime);
            renderGame();
            requestAnimationFrame(gameLoop);
        }

        // Êõ¥Êñ∞Ê∏∏ÊàèÁä∂ÊÄÅ
        function updateGame(deltaTime) {
            const now = Date.now();

            // Êõ¥Êñ∞Ê∏∏ÊàèÈÄüÂ∫¶
            if (now - gameState.lastSpeedIncreaseTime >= gameState.speedIncreaseInterval) {
                gameState.speed = Math.min(8, gameState.speed + 0.2);
                gameState.lastSpeedIncreaseTime = now;
            }

            // Êõ¥Êñ∞ÂàÜÊï∞ÂèòÂåñ
            if (now - gameState.lastScoreChangeTime >= gameState.scoreChangeInterval) {
                updateProjectileScores();
                gameState.lastScoreChangeTime = now;
            }

            // Êõ¥Êñ∞ÂàÜÊï∞ÂèòÂåñÂÄíËÆ°Êó∂ÊòæÁ§∫
            const timeUntilNextChange = Math.max(0, gameState.scoreChangeInterval - (now - gameState.lastScoreChangeTime));
            document.getElementById('scoreChangeTimer').textContent = (timeUntilNextChange / 1000).toFixed(1) + 's';

            // Êõ¥Êñ∞ÈÅìÂÖ∑ÂÜ∑Âç¥
            updatePowerCooldowns();

            // Êõ¥Êñ∞Ê†∏ÂøÉ‰ΩçÁΩÆ
            if (gameState.cores && gameState.cores.length > 0 && !isMobileDevice()) {
                gameState.cores.forEach(core => {
                    // ËÆæÁΩÆÁõÆÊ†á‰ΩçÁΩÆ
                    core.targetX = Math.max(core.size, Math.min(canvas.width - core.size, gameState.mouseX));
                    core.targetY = Math.max(core.size, Math.min(canvas.height - core.size, gameState.mouseY));
                    
                    // Ê†πÊçÆÊÉØÊÄßËÆæÁΩÆÊõ¥Êñ∞‰ΩçÁΩÆ
                    if (gameState.inertiaEnabled) {
                        core.x += (core.targetX - core.x) * gameState.coreSmoothing;
                        core.y += (core.targetY - core.y) * gameState.coreSmoothing;
                    } else {
                        core.x = core.targetX;
                        core.y = core.targetY;
                    }
                });
            }

            // ÁîüÊàêÊäïÂ∞Ñ‰Ωì
            if (now - gameState.lastProjectileTime >= gameState.projectileInterval) {
                generateProjectile();
                gameState.lastProjectileTime = now;
            }

            // Á°Æ‰øùÊäïÂ∞Ñ‰ΩìÊï∞ÈáèÂú®ÂêàÁêÜËåÉÂõ¥ÂÜÖ
            while (gameState.projectiles.length > gameState.maxProjectiles) {
                gameState.projectiles.shift();
            }

            // Â¶ÇÊûúÊäïÂ∞Ñ‰ΩìÊï∞ÈáèÂ§™Â∞ëÔºåÁ´ãÂç≥ÁîüÊàêÊñ∞ÁöÑ
            if (gameState.projectiles.length < gameState.minProjectiles) {
                const needed = gameState.minProjectiles - gameState.projectiles.length;
                for (let i = 0; i < needed; i++) {
                    generateProjectile();
                }
            }

            // Êõ¥Êñ∞ÊäïÂ∞Ñ‰Ωì
            const projectilesToRemove = new Set();

            for (let i = gameState.projectiles.length - 1; i >= 0; i--) {
                const projectile = gameState.projectiles[i];

                // Êõ¥Êñ∞‰ΩçÁΩÆ
                if (!gameState.powers.freeze.active) {
                    projectile.x += projectile.dx * gameState.speed * deltaTime * 60; // Ë∞ÉÊï¥ÈÄüÂ∫¶‰ª•ÈÄÇÂ∫îÂ∏ßÁéá
                    projectile.y += projectile.dy * gameState.speed * deltaTime * 60;
                }

                // Ê£ÄÊü•ÂèòËâ≤
                if (projectile.color !== '#ff0000' && now - projectile.creationTime >= projectile.changeColorTime) {
                    const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#800080', '#000000'];
                    const newColor = colors[Math.floor(Math.random() * colors.length)];
                    projectile.color = newColor;
                    projectile.originalColor = newColor;
                }

                // Ê£ÄÊü•Ë£ÇÂèò
                if (projectile.willSplit && now - projectile.creationTime >= projectile.splitTime) {
                    const splitCount = Math.floor(Math.random() * 4) + 2;
                    for (let j = 0; j < splitCount; j++) {
                        const angle = (Math.random() * 60 - 30) * Math.PI / 180;
                        const cos = Math.cos(angle);
                        const sin = Math.sin(angle);
                        const newDx = projectile.dx * cos - projectile.dy * sin;
                        const newDy = projectile.dx * sin + projectile.dy * cos;

                        gameState.projectiles.push({
                            x: projectile.x,
                            y: projectile.y,
                            dx: newDx * 1.5,
                            dy: newDy * 1.5,
                            color: projectile.color,
                            size: projectile.size * 0.7,
                            originalColor: projectile.originalColor,
                            creationTime: now,
                            changeColorTime: projectile.changeColorTime
                        });
                    }
                    projectilesToRemove.add(i);
                    continue;
                }

                // Ê£ÄÊü•ÊòØÂê¶Âáª‰∏≠Ê†∏ÂøÉ
                if (gameState.cores && gameState.cores.length > 0) {
                    for (const core of gameState.cores) {
                        const dx = projectile.x - core.x;
                        const dy = projectile.y - core.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);

                        if (distance < core.size) {
                            // Â§ÑÁêÜÂæóÂàÜ
                            if (!gameState.powers.shield.active) {
                                const score = gameState.colorMode ? 
                                    Math.abs(gameState.projectileScores[getColorName(projectile.color)]) : // ÂèòËâ≤Ê®°Âºè‰∏ãÂº∫Âà∂Ê≠£Êï∞
                                    gameState.projectileScores[getColorName(projectile.color)];
                                if (gameState.powers.double.active) {
                                    gameState.score += score * 2;
                                    showScoreEffect(score * 2, core.x, core.y); // ÊòæÁ§∫ÂèåÂÄçÂàÜÊï∞ÊïàÊûú
                                } else {
                                    gameState.score += score;
                                    showScoreEffect(score, core.x, core.y); // ÊòæÁ§∫ÊôÆÈÄöÂàÜÊï∞ÊïàÊûú
                                }
                                // Êõ¥Êñ∞ÁâπÊïàÁä∂ÊÄÅ
                                updateEffects(score, projectile.color);
                            }

                            // Â§ÑÁêÜ‰º§ÂÆ≥
                            if (projectile.color === '#ff0000' && !gameState.powers.shield.active && !gameState.powers.invincible.active && !gameState.colorMode) {
                                const damage = gameState.powers.double.active ? 2 : 1;
                                gameState.health -= damage;
                                core.size += 5 * damage;
                            }

                            projectilesToRemove.add(i);
                            break;
                        }
                    }
                }

                // Ê£ÄÊü•ÊòØÂê¶Ë∂ÖÂá∫Â±èÂπï
                if (projectile.x < -50 || projectile.x > canvas.width + 50 ||
                    projectile.y < -50 || projectile.y > canvas.height + 50) {
                    projectilesToRemove.add(i);
                }
            }

            // ‰ªéÂêéÂêëÂâçÁßªÈô§ÊäïÂ∞Ñ‰Ωì
            const sortedIndices = Array.from(projectilesToRemove).sort((a, b) => b - a);
            for (const index of sortedIndices) {
                gameState.projectiles.splice(index, 1);
            }

            // Êõ¥Êñ∞Ê∏∏ÊàèÊó∂Èó¥
            gameState.time += deltaTime;

            // Ê£ÄÊü•Ê∏∏ÊàèÊòØÂê¶ÁªìÊùü
            if (gameState.health <= 0) {
                endGame();
            }
        }

        // Êõ¥Êñ∞ÊäïÂ∞Ñ‰ΩìÂàÜÊï∞
        function updateProjectileScores() {
            const colors = ['red', 'green', 'blue', 'yellow', 'purple', 'black'];
            colors.forEach(color => {
                const sign = gameState.colorMode ? 1 : (Math.random() < 0.5 ? 1 : -1);
                const value = Math.floor(Math.random() * 11); // 0-10
                gameState.projectileScores[color] = sign * value;
                
                // Êõ¥Êñ∞UIÊòæÁ§∫
                const scoreElement = document.getElementById(color + 'Score');
                if (scoreElement) {
                    scoreElement.textContent = sign * value;
                }
            });
        }

        // Ëé∑ÂèñÈ¢úËâ≤ÂêçÁß∞
        function getColorName(color) {
            const colorMap = {
                '#ff0000': 'red',
                '#00ff00': 'green',
                '#0000ff': 'blue',
                '#ffff00': 'yellow',
                '#800080': 'purple',
                '#000000': 'black'
            };
            return colorMap[color] || 'red';
        }

        // Ê†ºÂºèÂåñÊó∂Èó¥
        function formatTime(time) {
            // Â∞ÜÊó∂Èó¥ËΩ¨Êç¢‰∏∫ÁßíÊï∞ÔºåÂêë‰∏ãÂèñÊï¥
            const totalSeconds = Math.floor(time);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // Êõ¥Êñ∞ÈÅìÂÖ∑Áä∂ÊÄÅÊòæÁ§∫
        function updatePowerStatus() {
            Object.keys(gameState.powers).forEach(power => {
                const status = document.getElementById(power + 'Status');
                const cooldown = document.getElementById(power + 'Cooldown');
                
                if (gameState.powers[power].active) {
                    status.className = 'power-indicator active';
                    cooldown.textContent = 'ÊøÄÊ¥ª‰∏≠';
                } else if (gameState.powers[power].cooldown > 0) {
                    status.className = 'power-indicator cooldown';
                    cooldown.textContent = `${gameState.powers[power].cooldown.toFixed(1)}s (${gameState.powers[power].uses}Ê¨°)`;
                } else {
                    status.className = 'power-indicator ready';
                    cooldown.textContent = `Â∞±Áª™ (${gameState.powers[power].uses}Ê¨°)`;
                }
            });
        }

        // Êõ¥Êñ∞ÈÅìÂÖ∑ÂÜ∑Âç¥Êó∂Èó¥
        function updatePowerCooldowns() {
            Object.keys(gameState.powers).forEach(power => {
                if (gameState.powers[power].cooldown > 0) {
                    gameState.powers[power].cooldown -= 0.1;
                }
            });
        }

        // Ê∏≤ÊüìÊ∏∏Êàè
        function renderGame() {
            // Ê∏ÖÁ©∫ÁîªÂ∏É
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // ÁªòÂà∂ËÉåÊôØ
            if (gameState.useCustomBg) {
                // ‰ΩøÁî®ÊµÖÁÅ∞Ëâ≤ËÉåÊôØ
                ctx.fillStyle = '#f0f0f0';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            } else {
                // ‰ΩøÁî®Âä®ÊÄÅËÉåÊôØÂõæÁâá
                if (gameState.backgroundImage.complete) {
                    ctx.drawImage(gameState.backgroundImage, 0, 0, canvas.width, canvas.height);
                }
            }

            // Ê∏≤ÊüìÊäïÂ∞Ñ‰Ωì
            gameState.projectiles.forEach(projectile => {
                ctx.beginPath();
                ctx.arc(projectile.x, projectile.y, projectile.size, 0, Math.PI * 2);
                ctx.fillStyle = projectile.color;
                ctx.fill();
                ctx.closePath();
            });

            // Ê∏≤ÊüìÊ†∏ÂøÉ
            if (gameState.cores && gameState.cores.length > 0) {
                gameState.cores.forEach(core => {
                    // ÁªòÂà∂Ê†∏ÂøÉÂ§ñÂúà
                    ctx.beginPath();
                    ctx.arc(core.x, core.y, core.size, 0, Math.PI * 2);
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                    ctx.fill();
                    ctx.closePath();

                    // ÁªòÂà∂Ê†∏ÂøÉ‰∏≠Âúà
                    ctx.beginPath();
                    ctx.arc(core.x, core.y, core.size * 0.7, 0, Math.PI * 2);
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
                    ctx.fill();
                    ctx.closePath();

                    // ÁªòÂà∂Ê†∏ÂøÉÂÜÖÂúà
                    ctx.beginPath();
                    ctx.arc(core.x, core.y, core.size * 0.4, 0, Math.PI * 2);
                    ctx.fillStyle = '#ffffff';
                    ctx.fill();
                    ctx.closePath();

                    // ÁªòÂà∂Ê†∏ÂøÉËæπÊ°Ü
                    ctx.beginPath();
                    ctx.arc(core.x, core.y, core.size, 0, Math.PI * 2);
                    ctx.strokeStyle = '#000000';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    ctx.closePath();

                    // Â¶ÇÊûúÊúâÊä§ÁõæÊïàÊûúÔºåÁªòÂà∂Êä§ÁõæÂÖâÁéØ
                    if (gameState.powers.shield.active) {
                        ctx.beginPath();
                        ctx.arc(core.x, core.y, core.size + 10, 0, Math.PI * 2);
                        ctx.strokeStyle = 'rgba(76, 175, 80, 0.5)';
                        ctx.lineWidth = 3;
                        ctx.stroke();
                        ctx.closePath();
                    }

                    // Â¶ÇÊûúÊúâÊó†ÊïåÊïàÊûúÔºåÁªòÂà∂Êó†ÊïåÂÖâÁéØ
                    if (gameState.powers.invincible.active) {
                        ctx.beginPath();
                        ctx.arc(core.x, core.y, core.size + 15, 0, Math.PI * 2);
                        ctx.strokeStyle = 'rgba(255, 215, 0, 0.5)';
                        ctx.lineWidth = 3;
                        ctx.stroke();
                        ctx.closePath();
                    }
                });
            }

            // Êõ¥Êñ∞UI
            document.getElementById('score').textContent = gameState.score;
            document.getElementById('health').textContent = gameState.health;
            document.getElementById('speed').textContent = gameState.speed.toFixed(1) + 'x';
            document.getElementById('time').textContent = formatTime(gameState.time);

            // Êõ¥Êñ∞ÈÅìÂÖ∑Áä∂ÊÄÅ
            updatePowerStatus();
        }

        // ÊøÄÊ¥ªÊä§Áõæ
        function activateShield() {
            if (gameState.powers.shield.uses > 0 && gameState.powers.shield.cooldown <= 0) {
                gameState.powers.shield.active = true;
                gameState.powers.shield.uses--;
                gameState.powers.shield.cooldown = 15; // 15ÁßíÂÜ∑Âç¥
                setTimeout(() => {
                    gameState.powers.shield.active = false;
                }, 5000); // 5ÁßíÊåÅÁª≠Êó∂Èó¥
            }
        }

        // ÊøÄÊ¥ªÂÜªÁªì
        function activateFreeze() {
            if (gameState.powers.freeze.uses > 0 && gameState.powers.freeze.cooldown <= 0) {
                gameState.powers.freeze.active = true;
                gameState.powers.freeze.uses--;
                gameState.powers.freeze.cooldown = 15; // 15ÁßíÂÜ∑Âç¥
                setTimeout(() => {
                    gameState.powers.freeze.active = false;
                }, 5000); // 5ÁßíÊåÅÁª≠Êó∂Èó¥
            }
        }

        // ÊøÄÊ¥ªÂèåÂÄçÂàÜÊï∞
        function activateDoubleScore() {
            if (gameState.powers.double.uses > 0 && gameState.powers.double.cooldown <= 0) {
                gameState.powers.double.active = true;
                gameState.powers.double.uses--;
                gameState.powers.double.cooldown = 20; // 20ÁßíÂÜ∑Âç¥
                setTimeout(() => {
                    gameState.powers.double.active = false;
                }, 8000); // 8ÁßíÊåÅÁª≠Êó∂Èó¥
            }
        }

        // ÊøÄÊ¥ªÊó†Êïå
        function activateInvincible() {
            if (gameState.powers.invincible.uses > 0 && gameState.powers.invincible.cooldown <= 0) {
                gameState.powers.invincible.active = true;
                gameState.powers.invincible.uses--;
                gameState.powers.invincible.cooldown = 30; // 30ÁßíÂÜ∑Âç¥
                setTimeout(() => {
                    gameState.powers.invincible.active = false;
                }, 3000); // 3ÁßíÊåÅÁª≠Êó∂Èó¥
            }
        }

        // ÁªìÊùüÊ∏∏Êàè
        function endGame() {
            if (!gameState.isGameRunning) return; // Èò≤Ê≠¢ÈáçÂ§çË∞ÉÁî®
            
            gameState.isGameRunning = false;
            
            // Ëé∑ÂèñÁé©ÂÆ∂‰ø°ÊÅØ
            const playerNickname = localStorage.getItem('playerNickname');
            if (!playerNickname) {
                console.error('Êú™ÊâæÂà∞Áé©ÂÆ∂ÊòµÁß∞');
                window.location.href = 'Start.html';
                return;
            }
            
            // ‰øùÂ≠òÊ∏∏ÊàèÊï∞ÊçÆ
            const finalScore = Math.floor(gameState.score || 0);
            const gameTime = Math.max(0, parseFloat(gameState.time || 0));
            
            console.log('‰øùÂ≠òÊ∏∏ÊàèÊï∞ÊçÆÔºö', {
                nickname: playerNickname,
                score: finalScore,
                time: gameTime
            });
            
            // ‰øùÂ≠òÊúÄÁªàÂæóÂàÜÂíåÊó∂Èó¥
            localStorage.setItem('finalScore', finalScore.toString());
            localStorage.setItem('gameTime', gameTime.toString());
            
            // Êõ¥Êñ∞ÊúÄÈ´òÂàÜ
            let highScores = [];
            try {
                const savedScores = localStorage.getItem('highScores');
                console.log('ËØªÂèñÂà∞ÁöÑÂéÜÂè≤ËÆ∞ÂΩïÔºö', savedScores);
                
                // Â¶ÇÊûúÂ≠òÂú®ÊóßÊï∞ÊçÆÔºåÂ∞ùËØïËß£Êûê
                if (savedScores) {
                    try {
                        highScores = JSON.parse(savedScores);
                        // Ê£ÄÊü•ÊòØÂê¶ÊòØÊóßÊ†ºÂºèÔºàÊï∞Â≠óÊï∞ÁªÑÔºâ
                        if (Array.isArray(highScores) && highScores.length > 0 && typeof highScores[0] === 'number') {
                            console.log('Ê£ÄÊµãÂà∞ÊóßÊ†ºÂºèÊï∞ÊçÆÔºåÈáçÁΩÆ‰∏∫Á©∫Êï∞ÁªÑ');
                            highScores = [];
                        }
                    } catch (error) {
                        console.error('Ëß£ÊûêÂéÜÂè≤ËÆ∞ÂΩïÂ§±Ë¥•Ôºö', error);
                        highScores = [];
                    }
                }
                
                // Á°Æ‰øùhighScoresÊòØÊï∞ÁªÑ
                if (!Array.isArray(highScores)) {
                    console.log('highScores‰∏çÊòØÊï∞ÁªÑÔºåÈáçÁΩÆ‰∏∫Á©∫Êï∞ÁªÑ');
                    highScores = [];
                }
            } catch (error) {
                console.error('ËØªÂèñÊúÄÈ´òÂàÜÂ§±Ë¥•Ôºö', error);
                highScores = [];
            }
            
            // Ê∑ªÂä†ÂΩìÂâçÊ∏∏ÊàèËÆ∞ÂΩï
            const currentScore = {
                nickname: playerNickname,
                score: finalScore,
                time: gameTime,
                timestamp: Date.now()
            };
            
            console.log('Ê∑ªÂä†Êñ∞ËÆ∞ÂΩïÔºö', currentScore);
            
            // ‰øùÂ≠òÊâÄÊúâËÆ∞ÂΩï
            highScores.push(currentScore);
            
            // ÊåâÊó∂Èó¥Êà≥ÊéíÂ∫èÔºà‰ªéÊñ∞Âà∞ÊóßÔºâ
            highScores.sort((a, b) => b.timestamp - a.timestamp);
            
            // Âè™‰øùÁïôÊúÄÊñ∞ÁöÑ5Êù°ËÆ∞ÂΩï
            highScores = highScores.slice(0, 5);
            
            // ‰øùÂ≠òÊõ¥Êñ∞ÂêéÁöÑÊéíË°åÊ¶ú
            try {
                const scoresString = JSON.stringify(highScores);
                console.log('ÂáÜÂ§á‰øùÂ≠òÁöÑÊï∞ÊçÆÔºö', scoresString);
                localStorage.setItem('highScores', scoresString);
                console.log('‰øùÂ≠òÊúÄÈ´òÂàÜÊàêÂäüÔºö', highScores);
            } catch (error) {
                console.error('‰øùÂ≠òÊúÄÈ´òÂàÜÂ§±Ë¥•Ôºö', error);
            }
            
            // Ë∑≥ËΩ¨Âà∞ÁªìÁÆóÈ°µÈù¢
            window.location.href = 'Gameover.html';
        }

        // Êõ¥Êñ∞ÁâπÊïàÁä∂ÊÄÅ
        function updateEffects(score, projectileColor) {
            const effects = gameState.effects;
            
            // Êõ¥Êñ∞ÁâπÊïàÈù¢ÊùøÊòæÁ§∫
            document.getElementById('effectsPanel').style.display = 'block';
            
            // ÁÅµÊïèÁâπÊïàÔºöËøûÁª≠Ë∫≤ÈÅøÁ∫¢Ëâ≤ÊäïÂ∞ÑÁâ©
            if (projectileColor === '#ff0000') {
                effects.redDodgeCount++;
                document.getElementById('effectSensitive').textContent = `ÁÅµÊïè: ${effects.redDodgeCount}/10`;
                if (effects.redDodgeCount >= 10) {
                    triggerEffect('sensitive');
                }
            } else {
                effects.redDodgeCount = 0;
                document.getElementById('effectSensitive').textContent = `ÁÅµÊïè: ${effects.redDodgeCount}/10`;
            }

            // Á≤æÂáÜÁâπÊïàÔºöËøûÁª≠ÂæóÂàÜ
            if (score > 0) {
                effects.consecutiveScore++;
                effects.lastPositiveScore = gameState.score;
                document.getElementById('effectPrecise').textContent = `Á≤æÂáÜ: ${effects.consecutiveScore}/20`;
                if (effects.consecutiveScore >= 20) {
                    triggerEffect('precise');
                }
            } else {
                effects.consecutiveScore = 0;
                document.getElementById('effectPrecise').textContent = `Á≤æÂáÜ: ${effects.consecutiveScore}/20`;
            }

            // ÈõÜ‰∏≠Ê≥®ÊÑèÁâπÊïàÔºöÁ¥ØËÆ°ÂáèÂàÜ
            if (score < 0) {
                effects.negativeScoreTotal += Math.abs(score);
                document.getElementById('effectFocused').textContent = `ÈõÜ‰∏≠Ê≥®ÊÑè: ${effects.negativeScoreTotal}/30`;
                if (effects.negativeScoreTotal >= 30 && gameState.score <= effects.lastPositiveScore) {
                    triggerEffect('focused');
                }
            }
        }

        // Ëß¶ÂèëÁâπÊïà
        function triggerEffect(type) {
            const effectElement = document.getElementById(`effect${type.charAt(0).toUpperCase() + type.slice(1)}`);
            effectElement.classList.add('active');
            
            switch(type) {
                case 'sensitive':
                    // Ëé∑ÂæóÊó†Êïå+1
                    gameState.powers.invincible.uses++;
                    showEffectMessage('Ëé∑ÂæóÊó†Êïå+1');
                    break;
                case 'precise':
                    // Ëé∑ÂæóÊä§Áõæ+1
                    gameState.powers.shield.uses++;
                    showEffectMessage('Ëé∑ÂæóÊä§Áõæ+1');
                    break;
                case 'focused':
                    // ÊöÇÊó†Â•ñÂä±
                    showEffectMessage('ÈõÜ‰∏≠Ê≥®ÊÑèÔºÅ');
                    break;
            }

            // ÈáçÁΩÆÁõ∏ÂÖ≥ËÆ°Êï∞
            switch(type) {
                case 'sensitive':
                    gameState.effects.redDodgeCount = 0;
                    break;
                case 'precise':
                    gameState.effects.consecutiveScore = 0;
                    break;
                case 'focused':
                    gameState.effects.negativeScoreTotal = 0;
                    break;
            }

            // 3ÁßíÂêéÁßªÈô§ÁâπÊïàÂä®Áîª
            setTimeout(() => {
                effectElement.classList.remove('active');
            }, 3000);
        }

        // ÊòæÁ§∫ÁâπÊïàÊ∂àÊÅØ
        function showEffectMessage(message) {
            const messageElement = document.createElement('div');
            messageElement.style.cssText = `
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0, 0, 0, 0.8);
                color: #4CAF50;
                padding: 15px 30px;
                border-radius: 5px;
                font-size: 24px;
                z-index: 1000;
                animation: fadeOut 2s forwards;
            `;
            messageElement.textContent = message;
            document.body.appendChild(messageElement);

            // 2ÁßíÂêéÁßªÈô§Ê∂àÊÅØ
            setTimeout(() => {
                messageElement.remove();
            }, 2000);
        }

        // Ê∑ªÂä†Ê∂àÊÅØÂä®ÁîªÊ†∑Âºè
        const messageStyle = document.createElement('style');
        messageStyle.textContent = `
            @keyframes fadeOut {
                0% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
                50% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
                100% { opacity: 0; transform: translate(-50%, -50%) scale(1); }
            }
        `;
        document.head.appendChild(messageStyle);

        // Ê∑ªÂä†ÂàÜÊï∞ÂèòÂåñÁâπÊïàÊòæÁ§∫ÂáΩÊï∞
        function showScoreEffect(score, x, y) {
            const effectElement = document.createElement('div');
            const isPositive = score > 0;
            const prefix = isPositive ? '+' : '';
            
            effectElement.style.cssText = `
                position: absolute;
                left: ${x}px;
                top: ${y}px;
                color: ${isPositive ? '#4CAF50' : '#ff0000'};
                font-size: 20px;
                font-weight: bold;
                pointer-events: none;
                z-index: 1000;
                text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
                animation: scoreFloat 1s ease-out forwards;
            `;
            
            effectElement.textContent = `${prefix}${score}`;
            document.body.appendChild(effectElement);

            // 1ÁßíÂêéÁßªÈô§ÁâπÊïà
            setTimeout(() => {
                effectElement.remove();
            }, 1000);
        }

        // Ê∑ªÂä†ÂàÜÊï∞ÊµÆÂä®Âä®ÁîªÊ†∑Âºè
        const scoreAnimationStyle = document.createElement('style');
        scoreAnimationStyle.textContent = `
            @keyframes scoreFloat {
                0% {
                    opacity: 1;
                    transform: translate(-50%, -50%) scale(1);
                }
                50% {
                    opacity: 0.8;
                    transform: translate(-50%, -100%) scale(1.2);
                }
                100% {
                    opacity: 0;
                    transform: translate(-50%, -150%) scale(1);
                }
            }
        `;
        document.head.appendChild(scoreAnimationStyle);

        // Êõ¥Êñ∞Ê∏∏ÊàèÊ®°Âºè‰ø°ÊÅØ
        function updateGameModeInfo() {
            const modeElement = document.getElementById('gameMode');
            const featureElement = document.getElementById('coreFeature');
            const multiplierElement = document.getElementById('scoreMultiplier');

            switch(gameState.mode) {
                case 'EASY':
                    modeElement.textContent = 'ÁÆÄÂçïÊ®°Âºè';
                    featureElement.textContent = 'Âõ∫ÂÆöÂ§ßÂ∞èÊ†∏ÂøÉ';
                    multiplierElement.textContent = '1.0x';
                    break;
                case 'MEDIUM':
                    modeElement.textContent = '‰∏≠Á≠âÊ®°Âºè';
                    featureElement.textContent = 'Ë¥™ÂêÉËõáÊ†∏ÂøÉÔºàÈïøÂ∫¶ÈöèÂæóÂàÜÂ¢ûÂä†Ôºâ';
                    multiplierElement.textContent = '1.5x';
                    break;
                case 'HARD':
                    modeElement.textContent = 'Âõ∞ÈöæÊ®°Âºè';
                    featureElement.textContent = 'ÂëºÂê∏Ê†∏ÂøÉÔºàÂ§ßÂ∞èÂë®ÊúüÊÄßÂèòÂåñÔºâ';
                    multiplierElement.textContent = '2.0x';
                    break;
            }
        }

        // ‰øÆÊîπÁßªÂä®Á´ØÊéßÂà∂ÊîØÊåÅ
        function setupMobileControls() {
            const canvas = document.getElementById('gameCanvas');
            let isDragging = false;
            let lastTouchX = 0;
            let lastTouchY = 0;

            // Â§ÑÁêÜËß¶Êë∏ÂºÄÂßã
            canvas.addEventListener('touchstart', function(e) {
                e.preventDefault();
                isDragging = true;
                const touch = e.touches[0];
                const rect = canvas.getBoundingClientRect();
                lastTouchX = touch.clientX - rect.left;
                lastTouchY = touch.clientY - rect.top;
                
                // Áõ¥Êé•Êõ¥Êñ∞Ê†∏ÂøÉ‰ΩçÁΩÆ
                if (gameState.cores && gameState.cores.length > 0) {
                    gameState.cores.forEach(core => {
                        core.x = Math.max(core.size, Math.min(canvas.width - core.size, lastTouchX));
                        core.y = Math.max(core.size, Math.min(canvas.height - core.size, lastTouchY));
                        core.targetX = core.x;
                        core.targetY = core.y;
                    });
                }
            }, { passive: false });

            // Â§ÑÁêÜËß¶Êë∏ÁßªÂä®
            canvas.addEventListener('touchmove', function(e) {
                e.preventDefault();
                if (!isDragging) return;

                const touch = e.touches[0];
                const rect = canvas.getBoundingClientRect();
                const currentX = touch.clientX - rect.left;
                const currentY = touch.clientY - rect.top;

                // Áõ¥Êé•Êõ¥Êñ∞Ê†∏ÂøÉ‰ΩçÁΩÆ
                if (gameState.cores && gameState.cores.length > 0) {
                    gameState.cores.forEach(core => {
                        core.x = Math.max(core.size, Math.min(canvas.width - core.size, currentX));
                        core.y = Math.max(core.size, Math.min(canvas.height - core.size, currentY));
                        core.targetX = core.x;
                        core.targetY = core.y;
                    });
                }

                lastTouchX = currentX;
                lastTouchY = currentY;
            }, { passive: false });

            // Â§ÑÁêÜËß¶Êë∏ÁªìÊùü
            canvas.addEventListener('touchend', function(e) {
                e.preventDefault();
                isDragging = false;
            }, { passive: false });

            // Â§ÑÁêÜËß¶Êë∏ÂèñÊ∂à
            canvas.addEventListener('touchcancel', function(e) {
                e.preventDefault();
                isDragging = false;
            }, { passive: false });

            // ËÆæÁΩÆÁßªÂä®Á´ØÊåâÈíÆ
            const shieldButton = document.getElementById('shieldButton');
            const freezeButton = document.getElementById('freezeButton');
            const doubleButton = document.getElementById('doubleButton');
            const invincibleButton = document.getElementById('invincibleButton');

            // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
            function updateButtonStates() {
                shieldButton.style.opacity = (gameState.powers.shield.uses > 0 && gameState.powers.shield.cooldown <= 0) ? '1' : '0.5';
                freezeButton.style.opacity = (gameState.powers.freeze.uses > 0 && gameState.powers.freeze.cooldown <= 0) ? '1' : '0.5';
                doubleButton.style.opacity = (gameState.powers.double.uses > 0 && gameState.powers.double.cooldown <= 0) ? '1' : '0.5';
                invincibleButton.style.opacity = (gameState.powers.invincible.uses > 0 && gameState.powers.invincible.cooldown <= 0) ? '1' : '0.5';
            }

            // ÂÆöÊúüÊõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
            setInterval(updateButtonStates, 100);

            // ËÆæÁΩÆÊåâÈíÆ‰∫ã‰ª∂
            shieldButton.addEventListener('touchstart', (e) => {
                e.preventDefault();
                if (gameState.powers.shield.uses > 0 && gameState.powers.shield.cooldown <= 0) {
                    activateShield();
                    updateButtonStates();
                }
            });

            freezeButton.addEventListener('touchstart', (e) => {
                e.preventDefault();
                if (gameState.powers.freeze.uses > 0 && gameState.powers.freeze.cooldown <= 0) {
                    activateFreeze();
                    updateButtonStates();
                }
            });

            doubleButton.addEventListener('touchstart', (e) => {
                e.preventDefault();
                if (gameState.powers.double.uses > 0 && gameState.powers.double.cooldown <= 0) {
                    activateDoubleScore();
                    updateButtonStates();
                }
            });

            invincibleButton.addEventListener('touchstart', (e) => {
                e.preventDefault();
                if (gameState.powers.invincible.uses > 0 && gameState.powers.invincible.cooldown <= 0) {
                    activateInvincible();
                    updateButtonStates();
                }
            });

            // ËÆæÁΩÆÁßªÂä®Á´ØÂäüËÉΩÊåâÈíÆ
            document.getElementById('bgToggleMobile').addEventListener('touchstart', (e) => {
                e.preventDefault();
                gameState.useCustomBg = !gameState.useCustomBg;
                this.classList.toggle('active');
                this.textContent = gameState.useCustomBg ? 'ÂàáÊç¢ËÉåÊôØ' : 'ÊÅ¢Â§çÁÅ∞Ëâ≤';
            });

            document.getElementById('inertiaToggleMobile').addEventListener('touchstart', (e) => {
                e.preventDefault();
                gameState.inertiaEnabled = !gameState.inertiaEnabled;
                this.classList.toggle('active');
                this.textContent = gameState.inertiaEnabled ? 'ÊÉØÊÄß' : 'Êó†ÊÉØÊÄß';
                gameState.coreSmoothing = gameState.inertiaEnabled ? 0.15 : 1;
            });

            document.getElementById('colorToggleMobile').addEventListener('touchstart', (e) => {
                e.preventDefault();
                gameState.colorMode = !gameState.colorMode;
                this.classList.toggle('active');
                this.textContent = gameState.colorMode ? 'ÊÅ¢Â§çÂéüËâ≤' : 'ÂèòËâ≤';
            });

            // ËÆæÁΩÆÁßªÂä®Á´ØÊ∏∏ÊàèÊéßÂà∂ÊåâÈíÆ
            document.getElementById('restartButton').addEventListener('touchstart', (e) => {
                e.preventDefault();
                gameState.isGameRunning = false;
                window.location.reload();
            });

            document.getElementById('exitButton').addEventListener('touchstart', (e) => {
                e.preventDefault();
                endGame();
            });
        }

        // Ê£ÄÊµãËÆæÂ§áÁ±ªÂûã
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñÊ∏∏Êàè
        window.addEventListener('load', function() {
            console.log('Page loaded, setting up game...');
            setupEventListeners();
            initGame();

            // ÂàùÂßãÂåñÈü≥‰πêÊéßÂà∂
            const musicToggle = document.getElementById('musicToggle');
            let bgMusic;
            
            // È¢ÑÂä†ËΩΩÈü≥È¢ë
            function preloadAudio() {
                return new Promise((resolve, reject) => {
                    bgMusic = new Audio('music/beethoven_virus.mp3');
                    bgMusic.loop = true;
                    
                    // ËÆæÁΩÆÈü≥È¢ëÂä†ËΩΩ‰∫ã‰ª∂
                    bgMusic.addEventListener('canplaythrough', () => {
                        console.log('Èü≥È¢ëÂä†ËΩΩÂÆåÊàê');
                        resolve(bgMusic);
                    });
                    
                    bgMusic.addEventListener('error', (e) => {
                        console.error('Èü≥È¢ëÂä†ËΩΩÂ§±Ë¥•:', e);
                        reject(e);
                    });
                    
                    // ÂºÄÂßãÂä†ËΩΩÈü≥È¢ë
                    bgMusic.load();
                });
            }

            // ÂàùÂßãÂåñÈü≥È¢ë
            preloadAudio().then(audio => {
                // ‰ªésessionStorageËé∑ÂèñÊí≠Êîæ‰ΩçÁΩÆ
                const musicData = sessionStorage.getItem('bgMusic');
                if (musicData) {
                    audio.currentTime = parseFloat(musicData);
                }
                
                // ‰ªélocalStorageËØªÂèñÈü≥‰πêÁä∂ÊÄÅ
                const isMusicMuted = localStorage.getItem('isMusicMuted') === 'true';
                if (!isMusicMuted) {
                    audio.play().catch(error => {
                        console.log('Ëá™Âä®Êí≠ÊîæË¢´ÈòªÊ≠¢ÔºåÁ≠âÂæÖÁî®Êà∑‰∫§‰∫í');
                    });
                } else {
                    musicToggle.classList.add('muted');
                }

                // Èü≥‰πêÊéßÂà∂ÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
                musicToggle.addEventListener('click', () => {
                    if (audio.paused) {
                        audio.play();
                        musicToggle.classList.remove('muted');
                        localStorage.setItem('isMusicMuted', 'false');
                    } else {
                        audio.pause();
                        musicToggle.classList.add('muted');
                        localStorage.setItem('isMusicMuted', 'true');
                    }
                });

                // ÂÆöÊúü‰øùÂ≠òÈü≥‰πêÊí≠Êîæ‰ΩçÁΩÆ
                setInterval(() => {
                    if (!audio.paused) {
                        sessionStorage.setItem('bgMusic', audio.currentTime);
                    }
                }, 1000);
            }).catch(error => {
                console.error('Èü≥È¢ëÂàùÂßãÂåñÂ§±Ë¥•:', error);
            });
        });

        // Ê∑ªÂä†Á™óÂè£Â§ßÂ∞èÊîπÂèò‰∫ã‰ª∂ÁõëÂê¨
        window.addEventListener('resize', resizeCanvas);
        window.addEventListener('orientationchange', resizeCanvas);
    </script>
</body>
</html> 