<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ ¸å¿ƒé˜²å¾¡ - æ¸¸æˆè¿›è¡Œä¸­</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;  /* æ”¹å›é»‘è‰² */
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: Arial, sans-serif;
            cursor: none; /* éšè—å…‰æ ‡ */
            touch-action: none; /* é˜²æ­¢ç§»åŠ¨ç«¯é»˜è®¤è§¦æ‘¸è¡Œä¸º */
        }

        #gameCanvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
            cursor: none; /* ç¡®ä¿ç”»å¸ƒä¸Šä¹Ÿéšè—å…‰æ ‡ */
        }

        #infoPanel {
            position: absolute;
            top: 0;
            right: 0;
            width: 300px;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 20px;
            box-sizing: border-box;
            z-index: 2;
            display: flex;
            flex-direction: column;
            gap: 20px;
            cursor: default;
            overflow-y: auto;
        }

        .panel-section {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .panel-section:last-child {
            margin-bottom: 0;
        }

        .panel-section h2 {
            margin: 0 0 10px 0;
            font-size: 18px;
            color: #4CAF50;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            font-size: 14px;
        }

        .power-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 5px 0;
            font-size: 14px;
            justify-content: space-between;
        }

        .power-status-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .power-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .active {
            background: #4CAF50;
        }

        .cooldown {
            background: #FFA500;
        }

        .ready {
            background: #fff;
        }

        .projectile-score {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 5px 0;
            font-size: 14px;
        }

        .projectile-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .controls {
            margin-top: auto;
            font-size: 14px;
            color: #aaa;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
        }

        .controls p {
            margin: 5px 0;
            font-size: 14px;
        }

        #shieldCooldown, #freezeCooldown, #doubleCooldown, #invincibleCooldown,
        #redScore, #greenScore, #blueScore, #yellowScore, #purpleScore, #blackScore,
        #scoreChangeTimer {
            font-size: 14px;
        }

        #bgToggle {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 3;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            border: 1px solid #4CAF50;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer; /* æŒ‰é’®æ˜¾ç¤ºæŒ‡é’ˆå…‰æ ‡ */
            font-size: 14px;
            transition: all 0.3s ease;
        }

        #inertiaToggle {
            position: absolute;
            bottom: 20px;
            left: 160px;
            z-index: 3;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            border: 1px solid #4CAF50;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        #colorToggle {
            position: absolute;
            bottom: 20px;
            left: 300px;
            z-index: 3;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            border: 1px solid #4CAF50;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        #bgToggle:hover, #inertiaToggle:hover, #colorToggle:hover {
            background: rgba(76, 175, 80, 0.2);
        }

        #bgToggle.active, #inertiaToggle.active, #colorToggle.active {
            background: rgba(76, 175, 80, 0.4);
        }

        #effectsPanel {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 3;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 15px;
            border-radius: 5px;
            font-size: 14px;
            display: none;
        }

        .effect-item {
            margin: 5px 0;
            padding: 5px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.1);
        }

        .effect-item.active {
            background: rgba(76, 175, 80, 0.3);
            animation: glow 1s infinite;
        }

        /* éŸ³ä¹æ§åˆ¶æŒ‰é’®æ ·å¼ */
        #musicToggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            border: 1px solid #4CAF50;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        #musicToggle:hover {
            background: rgba(76, 175, 80, 0.2);
        }

        #musicToggle.active {
            background: rgba(76, 175, 80, 0.4);
        }

        #musicToggle::before {
            content: 'ğŸ”Š';
            font-size: 20px;
        }

        #musicToggle.muted::before {
            content: 'ğŸ”‡';
        }

        @keyframes glow {
            0% { box-shadow: 0 0 5px rgba(76, 175, 80, 0.5); }
            50% { box-shadow: 0 0 20px rgba(76, 175, 80, 0.8); }
            100% { box-shadow: 0 0 5px rgba(76, 175, 80, 0.5); }
        }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            #infoPanel {
                width: 100%;
                height: auto;
                position: fixed;
                bottom: 0;
                top: auto;
                padding: 10px;
                font-size: 12px;
            }

            .panel-section {
                padding: 8px;
                margin-bottom: 5px;
            }

            .panel-section h2 {
                font-size: 14px;
                margin: 0 0 5px 0;
            }

            .info-item, .power-status, .projectile-score {
                font-size: 12px;
                margin: 3px 0;
            }

            #gameCanvas {
                width: 100%;
                height: 100%;
            }

            #bgToggle, #inertiaToggle, #colorToggle, #autoAvoid {
                padding: 8px 15px;
                font-size: 12px;
                bottom: 10px;
            }

            #bgToggle { left: 10px; }
            #inertiaToggle { left: 120px; }
            #colorToggle { left: 230px; }
            #autoAvoid { left: 340px; }
        }

        /* è™šæ‹Ÿæ‘‡æ†æ ·å¼ */
        #virtualJoystick {
            position: fixed;
            bottom: 100px;
            left: 50px;
            width: 100px;
            height: 100px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: none;
            z-index: 1000;
            touch-action: none;
        }

        #joystickKnob {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            touch-action: none;
        }

        /* ç§»åŠ¨ç«¯æ§åˆ¶æŒ‰é’®æ ·å¼ */
        .mobile-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: none;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }

        .mobile-button {
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
        }

        .mobile-button:active {
            background: rgba(255, 255, 255, 0.4);
        }

        /* ç§»åŠ¨ç«¯åŠŸèƒ½æŒ‰é’® */
        .mobile-functions {
            position: fixed;
            bottom: 20px;
            left: 20px;
            display: none;
            gap: 10px;
            z-index: 1000;
        }

        .function-button {
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            border: 1px solid #4CAF50;
            border-radius: 5px;
            font-size: 14px;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
        }

        .function-button:active {
            background: rgba(76, 175, 80, 0.4);
        }

        /* ç§»åŠ¨ç«¯æ¸¸æˆæ§åˆ¶æŒ‰é’® */
        .mobile-game-controls {
            position: fixed;
            top: 20px;
            left: 20px;
            display: none;
            gap: 10px;
            z-index: 1000;
        }

        .game-control-button {
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            border: 1px solid #ff4444;
            border-radius: 5px;
            font-size: 14px;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
        }

        .game-control-button:active {
            background: rgba(255, 68, 68, 0.4);
        }

        @media (max-width: 768px) {
            .mobile-controls, .mobile-functions, .mobile-game-controls {
                display: flex;
            }

            #infoPanel {
                width: 100%;
                height: auto;
                position: fixed;
                bottom: 100px;
                top: auto;
                padding: 10px;
                font-size: 12px;
            }

            #bgToggle, #inertiaToggle, #colorToggle {
                display: none;
            }
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    
    <!-- æ·»åŠ è™šæ‹Ÿæ‘‡æ† -->
    <div id="virtualJoystick">
        <div id="joystickKnob"></div>
    </div>

    <!-- ç§»åŠ¨ç«¯æ§åˆ¶æŒ‰é’® -->
    <div class="mobile-controls">
        <button class="mobile-button" id="shieldButton">ğŸ›¡ï¸</button>
        <button class="mobile-button" id="freezeButton">â„ï¸</button>
        <button class="mobile-button" id="doubleButton">2x</button>
        <button class="mobile-button" id="invincibleButton">ğŸ’«</button>
    </div>

    <!-- ç§»åŠ¨ç«¯åŠŸèƒ½æŒ‰é’® -->
    <div class="mobile-functions">
        <button class="function-button" id="bgToggleMobile">åˆ‡æ¢èƒŒæ™¯</button>
        <button class="function-button" id="inertiaToggleMobile">æƒ¯æ€§</button>
        <button class="function-button" id="colorToggleMobile">å˜è‰²</button>
    </div>

    <!-- ç§»åŠ¨ç«¯æ¸¸æˆæ§åˆ¶æŒ‰é’® -->
    <div class="mobile-game-controls">
        <button class="game-control-button" id="restartButton">é‡æ–°å¼€å§‹</button>
        <button class="game-control-button" id="exitButton">é€€å‡ºæ¸¸æˆ</button>
    </div>

    <!-- æ·»åŠ éŸ³ä¹æ§åˆ¶æŒ‰é’® -->
    <button id="musicToggle" class="active"></button>
    
    <button id="bgToggle">åˆ‡æ¢èƒŒæ™¯</button>
    <button id="inertiaToggle">æƒ¯æ€§</button>
    <button id="colorToggle">å˜è‰²</button>
    
    <div id="infoPanel">
        <div class="panel-section">
            <h2>æ¸¸æˆä¿¡æ¯</h2>
            <div class="info-item">
                <span>ç©å®¶ï¼š</span>
                <span id="playerNickname">ç©å®¶</span>
            </div>
            <div class="info-item">
                <span>åˆ†æ•°ï¼š</span>
                <span id="score">0</span>
            </div>
            <div class="info-item">
                <span>ç”Ÿå‘½å€¼ï¼š</span>
                <span id="health">100</span>
            </div>
            <div class="info-item">
                <span>æ¸¸æˆé€Ÿåº¦ï¼š</span>
                <span id="speed">1.0x</span>
            </div>
            <div class="info-item">
                <span>æ¸¸æˆæ—¶é—´ï¼š</span>
                <span id="time">0.0</span>
            </div>
        </div>

        <div class="panel-section">
            <h2>é“å…·çŠ¶æ€</h2>
            <div class="power-status">
                <div class="power-status-left">
                    <div class="power-indicator" id="shieldStatus"></div>
                    <span>æŠ¤ç›¾ (ç©ºæ ¼é”®)</span>
                </div>
                <span id="shieldCooldown"></span>
            </div>
            <div class="power-status">
                <div class="power-status-left">
                    <div class="power-indicator" id="freezeStatus"></div>
                    <span>å†»ç»“ (Fé”®)</span>
                </div>
                <span id="freezeCooldown"></span>
            </div>
            <div class="power-status">
                <div class="power-status-left">
                    <div class="power-indicator" id="doubleStatus"></div>
                    <span>åŒå€åˆ†æ•° (Dé”®)</span>
                </div>
                <span id="doubleCooldown"></span>
            </div>
            <div class="power-status">
                <div class="power-status-left">
                    <div class="power-indicator" id="invincibleStatus"></div>
                    <span>æ— æ•Œ (Ié”®)</span>
                </div>
                <span id="invincibleCooldown"></span>
            </div>
        </div>

        <div class="panel-section">
            <h2>æŠ•å°„ç‰©åˆ†æ•°</h2>
            <div class="projectile-score">
                <div class="projectile-dot" style="background: #ff0000"></div>
                <span>çº¢è‰²ï¼š</span>
                <span id="redScore">-10</span>
            </div>
            <div class="projectile-score">
                <div class="projectile-dot" style="background: #00ff00"></div>
                <span>ç»¿è‰²ï¼š</span>
                <span id="greenScore">5</span>
            </div>
            <div class="projectile-score">
                <div class="projectile-dot" style="background: #0000ff"></div>
                <span>è“è‰²ï¼š</span>
                <span id="blueScore">8</span>
            </div>
            <div class="projectile-score">
                <div class="projectile-dot" style="background: #ffff00"></div>
                <span>é»„è‰²ï¼š</span>
                <span id="yellowScore">3</span>
            </div>
            <div class="projectile-score">
                <div class="projectile-dot" style="background: #800080"></div>
                <span>ç´«è‰²ï¼š</span>
                <span id="purpleScore">-6</span>
            </div>
            <div class="projectile-score">
                <div class="projectile-dot" style="background: #000000"></div>
                <span>é»‘è‰²ï¼š</span>
                <span id="blackScore">0</span>
            </div>
            <div class="info-item">
                <span>åˆ†æ•°å˜åŒ–å€’è®¡æ—¶ï¼š</span>
                <span id="scoreChangeTimer">15.0s</span>
            </div>
        </div>

        <div class="controls">
            <p>ESC - è¿”å›ç»“ç®—é¡µé¢</p>
            <p>Q - è¿”å›æ¨¡å¼é€‰æ‹©</p>
            <p>R - é‡æ–°å¼€å§‹</p>
        </div>
    </div>

    <div id="effectsPanel">
        <div class="effect-item" id="effectSensitive">çµæ•: 0/10</div>
        <div class="effect-item" id="effectPrecise">ç²¾å‡†: 0/20</div>
        <div class="effect-item" id="effectFocused">é›†ä¸­æ³¨æ„: 0/30</div>
    </div>

    <script>
        // æ¸¸æˆä¸»é€»è¾‘ä»£ç 
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // æ¸¸æˆçŠ¶æ€
        let gameState = {
            score: 0,
            health: 100,
            speed: 1.0,
            time: 0,
            projectiles: [],
            cores: [],
            powers: {
                shield: { active: false, cooldown: 0, uses: 3 },
                freeze: { active: false, cooldown: 0, uses: 3 },
                double: { active: false, cooldown: 0, uses: 3 },
                invincible: { active: false, cooldown: 0, uses: 3 }
            },
            projectileScores: {
                red: -10,
                green: 5,
                blue: 8,
                yellow: 3,
                purple: -6,
                black: 0
            },
            mouseX: 0,
            mouseY: 0,
            lastProjectileTime: 0,
            projectileInterval: 1000,
            lastScoreChangeTime: 0,
            scoreChangeInterval: 15000,
            lastSpeedIncreaseTime: 0,
            speedIncreaseInterval: 10000,
            isGameRunning: false,
            backgroundImage: new Image(),
            useCustomBg: true,
            lastFrameTime: 0,
            coreSmoothing: 0.15,
            inertiaEnabled: true,
            colorMode: false, // æ·»åŠ å˜è‰²æ¨¡å¼çŠ¶æ€
            effects: {
                redDodgeCount: 0,
                consecutiveScore: 0,
                negativeScoreTotal: 0,
                lastPositiveScore: 0,
                effects: []
            },
            minProjectiles: 15,
            maxProjectiles: 40
        };

        // è®¾ç½®ç”»å¸ƒå¤§å°
        function resizeCanvas() {
            const isMobile = isMobileDevice();
            if (isMobile) {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            } else {
                canvas.width = window.innerWidth - 300;
                canvas.height = window.innerHeight;
            }
        }

        // æ·»åŠ é¼ æ ‡ç§»åŠ¨äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            canvas.addEventListener('mousemove', function(e) {
                const rect = canvas.getBoundingClientRect();
                gameState.mouseX = e.clientX - rect.left;
                gameState.mouseY = e.clientY - rect.top;
            });

            // æ·»åŠ èƒŒæ™¯åˆ‡æ¢æŒ‰é’®äº‹ä»¶ç›‘å¬
            document.getElementById('bgToggle').addEventListener('click', function() {
                gameState.useCustomBg = !gameState.useCustomBg;
                this.classList.toggle('active');
                this.textContent = gameState.useCustomBg ? 'åˆ‡æ¢èƒŒæ™¯' : 'æ¢å¤ç°è‰²';
            });

            // æ·»åŠ æƒ¯æ€§åˆ‡æ¢æŒ‰é’®äº‹ä»¶ç›‘å¬
            document.getElementById('inertiaToggle').addEventListener('click', function() {
                gameState.inertiaEnabled = !gameState.inertiaEnabled;
                this.classList.toggle('active');
                this.textContent = gameState.inertiaEnabled ? 'æƒ¯æ€§' : 'æ— æƒ¯æ€§';
                gameState.coreSmoothing = gameState.inertiaEnabled ? 0.15 : 1;
            });

            // æ·»åŠ å˜è‰²æŒ‰é’®äº‹ä»¶ç›‘å¬
            document.getElementById('colorToggle').addEventListener('click', function() {
                gameState.colorMode = !gameState.colorMode;
                this.classList.toggle('active');
                this.textContent = gameState.colorMode ? 'æ¢å¤åŸè‰²' : 'å˜è‰²';
            });

            document.addEventListener('keydown', function(e) {
                if (!gameState.isGameRunning) return;
                
                switch(e.key.toLowerCase()) {
                    case ' ': // ç©ºæ ¼é”® - æŠ¤ç›¾
                        e.preventDefault(); // é˜»æ­¢ç©ºæ ¼é”®çš„é»˜è®¤è¡Œä¸º
                        if (gameState.powers.shield.uses > 0 && gameState.powers.shield.cooldown <= 0) {
                            activateShield();
                        }
                        break;
                    case 'f': // Fé”® - å†»ç»“
                        if (gameState.powers.freeze.uses > 0 && gameState.powers.freeze.cooldown <= 0) {
                            activateFreeze();
                        }
                        break;
                    case 'd': // Dé”® - åŒå€åˆ†æ•°
                        if (gameState.powers.double.uses > 0 && gameState.powers.double.cooldown <= 0) {
                            activateDoubleScore();
                        }
                        break;
                    case 'i': // Ié”® - æ— æ•Œ
                        if (gameState.powers.invincible.uses > 0 && gameState.powers.invincible.cooldown <= 0) {
                            activateInvincible();
                        }
                        break;
                    case 'escape': // ESCé”® - è¿”å›ç»“ç®—é¡µé¢
                        e.preventDefault(); // é˜»æ­¢é»˜è®¤è¡Œä¸º
                        endGame();
                        break;
                    case 'q': // Qé”® - è¿”å›æ¨¡å¼é€‰æ‹©
                        gameState.isGameRunning = false;
                        window.location.href = 'Start.html';
                        break;
                    case 'r': // Ré”® - é‡æ–°å¼€å§‹
                        gameState.isGameRunning = false;
                        window.location.reload();
                        break;
                }
            });
        }

        // åˆå§‹åŒ–æ¸¸æˆ
        function initGame() {
            console.log('Initializing game...');
            const mode = localStorage.getItem('gameMode') || 'EASY';
            const nickname = localStorage.getItem('playerNickname') || 'ç©å®¶';
            
            // æ˜¾ç¤ºç©å®¶æ˜µç§°
            document.getElementById('playerNickname').textContent = nickname;
            
            // åŠ è½½èƒŒæ™¯å›¾ç‰‡
            gameState.backgroundImage.src = 'BG.png';
            
            // ç¡®ä¿ç”»å¸ƒå°ºå¯¸å·²æ›´æ–°
            resizeCanvas();
            
            // æ ¹æ®æ¨¡å¼è®¾ç½®æ ¸å¿ƒå’Œå˜è‰²æ—¶é—´é—´éš”
            switch(mode) {
                case 'EASY':
                    gameState.cores = [{
                        x: canvas.width / 2,
                        y: canvas.height / 2,
                        size: 20,
                        nickname: nickname,
                        targetX: canvas.width / 2,
                        targetY: canvas.height / 2
                    }];
                    gameState.scoreChangeInterval = 60000; // 60ç§’
                    break;
                case 'MEDIUM':
                    gameState.cores = [
                        {
                            x: canvas.width / 3,
                            y: canvas.height / 2,
                            size: 20,
                            nickname: nickname,
                            targetX: canvas.width / 3,
                            targetY: canvas.height / 2
                        },
                        {
                            x: (canvas.width * 2) / 3,
                            y: canvas.height / 2,
                            size: 20,
                            nickname: nickname,
                            targetX: (canvas.width * 2) / 3,
                            targetY: canvas.height / 2
                        }
                    ];
                    gameState.scoreChangeInterval = 30000; // 30ç§’
                    break;
                case 'HARD':
                    gameState.cores = [
                        {
                            x: canvas.width / 2,
                            y: canvas.height / 3,
                            size: 20,
                            nickname: nickname,
                            targetX: canvas.width / 2,
                            targetY: canvas.height / 3
                        },
                        {
                            x: canvas.width / 3,
                            y: (canvas.height * 2) / 3,
                            size: 20,
                            nickname: nickname,
                            targetX: canvas.width / 3,
                            targetY: (canvas.height * 2) / 3
                        },
                        {
                            x: (canvas.width * 2) / 3,
                            y: (canvas.height * 2) / 3,
                            size: 20,
                            nickname: nickname,
                            targetX: (canvas.width * 2) / 3,
                            targetY: (canvas.height * 2) / 3
                        }
                    ];
                    gameState.scoreChangeInterval = 10000; // 10ç§’
                    break;
            }

            // é‡ç½®æ¸¸æˆçŠ¶æ€
            gameState.score = 0;
            gameState.health = 100;
            gameState.speed = 1.0;
            gameState.time = 0;
            gameState.projectiles = [];
            gameState.powers = {
                shield: { active: false, cooldown: 0, uses: 3 },
                freeze: { active: false, cooldown: 0, uses: 3 },
                double: { active: false, cooldown: 0, uses: 3 },
                invincible: { active: false, cooldown: 0, uses: 3 }
            };
            gameState.lastProjectileTime = 0;
            gameState.lastScoreChangeTime = 0;
            gameState.lastSpeedIncreaseTime = 0;
            gameState.isGameRunning = true;

            // åˆå§‹åŒ–é¼ æ ‡ä½ç½®ä¸ºä¸­å¿ƒç‚¹
            gameState.mouseX = canvas.width / 2;
            gameState.mouseY = canvas.height / 2;

            // è®¾ç½®æŠ•å°„ä½“å‚æ•°
            gameState.minProjectiles = 15; // æœ€å°æŠ•å°„ä½“æ•°é‡
            gameState.maxProjectiles = 40; // æœ€å¤§æŠ•å°„ä½“æ•°é‡
            gameState.projectileInterval = 500; // åŸºç¡€ç”Ÿæˆé—´éš”ï¼ˆæ¯«ç§’ï¼‰

            // åˆå§‹ç”Ÿæˆä¸€äº›æŠ•å°„ä½“
            for (let i = 0; i < gameState.minProjectiles; i++) {
                generateProjectile();
            }

            // è®¾ç½®ç§»åŠ¨ç«¯æ§åˆ¶
            if (isMobileDevice()) {
                setupMobileControls();
            }

            console.log('Game initialized, starting game loop...');
            // å¯åŠ¨æ¸¸æˆå¾ªç¯
            requestAnimationFrame(gameLoop);
        }

        // ç”ŸæˆæŠ•å°„ä½“
        function generateProjectile() {
            const now = Date.now();
            if (now - gameState.lastProjectileTime < gameState.projectileInterval) {
                return;
            }
            gameState.lastProjectileTime = now;

            // å¦‚æœå½“å‰æŠ•å°„ä½“æ•°é‡å·²ç»è¾¾åˆ°ä¸Šé™ï¼Œç§»é™¤æœ€æ—©çš„ä¸€ä¸ª
            if (gameState.projectiles.length >= gameState.maxProjectiles) {
                gameState.projectiles.shift();
            }

            // éšæœºé€‰æ‹©ç”Ÿæˆä½ç½®ï¼ˆå±å¹•å››è¾¹ï¼‰
            const side = Math.floor(Math.random() * 4);
            let x, y;

            // æ ¹æ®è¾¹ç”Ÿæˆä½ç½®
            switch(side) {
                case 0: // ä¸Šè¾¹
                    x = Math.random() * canvas.width;
                    y = 0;
                    break;
                case 1: // å³è¾¹
                    x = canvas.width;
                    y = Math.random() * canvas.height;
                    break;
                case 2: // ä¸‹è¾¹
                    x = Math.random() * canvas.width;
                    y = canvas.height;
                    break;
                case 3: // å·¦è¾¹
                    x = 0;
                    y = Math.random() * canvas.height;
                    break;
            }

            // é€‰æ‹©ç›®æ ‡æ ¸å¿ƒï¼ˆæœ€è¿‘æˆ–æœ€è¿œï¼‰
            const targetType = Math.random() < 0.5 ? 'nearest' : 'furthest';
            let targetCore;
            let minDist = Infinity;
            let maxDist = 0;
            
            gameState.cores.forEach(core => {
                const dist = Math.sqrt(
                    Math.pow(core.x - x, 2) + 
                    Math.pow(core.y - y, 2)
                );
                if (targetType === 'nearest' && dist < minDist) {
                    minDist = dist;
                    targetCore = core;
                } else if (targetType === 'furthest' && dist > maxDist) {
                    maxDist = dist;
                    targetCore = core;
                }
            });

            // è®¡ç®—æ–¹å‘
            const dx = targetCore.x - x;
            const dy = targetCore.y - y;
            const length = Math.sqrt(dx * dx + dy * dy);
            const speed = gameState.speed;

            // éšæœºé€‰æ‹©é¢œè‰²
            const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#800080', '#000000'];
            const color = gameState.colorMode ? '#00ff00' : colors[Math.floor(Math.random() * colors.length)];

            // åˆ›å»ºæŠ•å°„ä½“
            const projectile = {
                x: x,
                y: y,
                dx: (dx / length) * speed,
                dy: (dy / length) * speed,
                color: color,
                size: 5,
                originalColor: color,
                creationTime: now,
                changeColorTime: Math.random() * 5000 + 2000 // 2-7ç§’åå˜è‰²
            };

            // 30%æ¦‚ç‡å‘ç”Ÿè£‚å˜
            if (Math.random() < 0.3) {
                projectile.willSplit = true;
                projectile.splitTime = Math.random() * 2000 + 1000; // 1-3ç§’åè£‚å˜
            }

            gameState.projectiles.push(projectile);
        }

        // æ¸¸æˆä¸»å¾ªç¯
        function gameLoop(timestamp) {
            if (!gameState.isGameRunning) return;
            
            // è®¡ç®—å¸§é—´éš”æ—¶é—´ï¼ˆç§’ï¼‰
            if (!gameState.lastFrameTime) {
                gameState.lastFrameTime = timestamp;
            }
            const deltaTime = (timestamp - gameState.lastFrameTime) / 1000; // è½¬æ¢ä¸ºç§’
            gameState.lastFrameTime = timestamp;
            
            updateGame(deltaTime);
            renderGame();
            requestAnimationFrame(gameLoop);
        }

        // æ›´æ–°æ¸¸æˆçŠ¶æ€
        function updateGame(deltaTime) {
            const now = Date.now();

            // æ›´æ–°æ¸¸æˆé€Ÿåº¦
            if (now - gameState.lastSpeedIncreaseTime >= gameState.speedIncreaseInterval) {
                gameState.speed = Math.min(8, gameState.speed + 0.2);
                gameState.lastSpeedIncreaseTime = now;
            }

            // æ›´æ–°åˆ†æ•°å˜åŒ–
            if (now - gameState.lastScoreChangeTime >= gameState.scoreChangeInterval) {
                updateProjectileScores();
                gameState.lastScoreChangeTime = now;
            }

            // æ›´æ–°åˆ†æ•°å˜åŒ–å€’è®¡æ—¶æ˜¾ç¤º
            const timeUntilNextChange = Math.max(0, gameState.scoreChangeInterval - (now - gameState.lastScoreChangeTime));
            document.getElementById('scoreChangeTimer').textContent = (timeUntilNextChange / 1000).toFixed(1) + 's';

            // æ›´æ–°é“å…·å†·å´
            updatePowerCooldowns();

            // æ›´æ–°æ ¸å¿ƒä½ç½®
            if (gameState.cores && gameState.cores.length > 0 && !isMobileDevice()) {
                gameState.cores.forEach(core => {
                    // è®¾ç½®ç›®æ ‡ä½ç½®
                    core.targetX = Math.max(core.size, Math.min(canvas.width - core.size, gameState.mouseX));
                    core.targetY = Math.max(core.size, Math.min(canvas.height - core.size, gameState.mouseY));
                    
                    // æ ¹æ®æƒ¯æ€§è®¾ç½®æ›´æ–°ä½ç½®
                    if (gameState.inertiaEnabled) {
                        core.x += (core.targetX - core.x) * gameState.coreSmoothing;
                        core.y += (core.targetY - core.y) * gameState.coreSmoothing;
                    } else {
                        core.x = core.targetX;
                        core.y = core.targetY;
                    }
                });
            }

            // ç”ŸæˆæŠ•å°„ä½“
            if (now - gameState.lastProjectileTime >= gameState.projectileInterval) {
                generateProjectile();
                gameState.lastProjectileTime = now;
            }

            // ç¡®ä¿æŠ•å°„ä½“æ•°é‡åœ¨åˆç†èŒƒå›´å†…
            while (gameState.projectiles.length > gameState.maxProjectiles) {
                gameState.projectiles.shift();
            }

            // å¦‚æœæŠ•å°„ä½“æ•°é‡å¤ªå°‘ï¼Œç«‹å³ç”Ÿæˆæ–°çš„
            if (gameState.projectiles.length < gameState.minProjectiles) {
                const needed = gameState.minProjectiles - gameState.projectiles.length;
                for (let i = 0; i < needed; i++) {
                    generateProjectile();
                }
            }

            // æ›´æ–°æŠ•å°„ä½“
            const projectilesToRemove = new Set();

            for (let i = gameState.projectiles.length - 1; i >= 0; i--) {
                const projectile = gameState.projectiles[i];

                // æ›´æ–°ä½ç½®
                if (!gameState.powers.freeze.active) {
                    projectile.x += projectile.dx * gameState.speed * deltaTime * 60; // è°ƒæ•´é€Ÿåº¦ä»¥é€‚åº”å¸§ç‡
                    projectile.y += projectile.dy * gameState.speed * deltaTime * 60;
                }

                // æ£€æŸ¥å˜è‰²
                if (projectile.color !== '#ff0000' && now - projectile.creationTime >= projectile.changeColorTime) {
                    const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#800080', '#000000'];
                    const newColor = colors[Math.floor(Math.random() * colors.length)];
                    projectile.color = newColor;
                    projectile.originalColor = newColor;
                }

                // æ£€æŸ¥è£‚å˜
                if (projectile.willSplit && now - projectile.creationTime >= projectile.splitTime) {
                    const splitCount = Math.floor(Math.random() * 4) + 2;
                    for (let j = 0; j < splitCount; j++) {
                        const angle = (Math.random() * 60 - 30) * Math.PI / 180;
                        const cos = Math.cos(angle);
                        const sin = Math.sin(angle);
                        const newDx = projectile.dx * cos - projectile.dy * sin;
                        const newDy = projectile.dx * sin + projectile.dy * cos;

                        gameState.projectiles.push({
                            x: projectile.x,
                            y: projectile.y,
                            dx: newDx * 1.5,
                            dy: newDy * 1.5,
                            color: projectile.color,
                            size: projectile.size * 0.7,
                            originalColor: projectile.originalColor,
                            creationTime: now,
                            changeColorTime: projectile.changeColorTime
                        });
                    }
                    projectilesToRemove.add(i);
                    continue;
                }

                // æ£€æŸ¥æ˜¯å¦å‡»ä¸­æ ¸å¿ƒ
                if (gameState.cores && gameState.cores.length > 0) {
                    for (const core of gameState.cores) {
                        const dx = projectile.x - core.x;
                        const dy = projectile.y - core.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);

                        if (distance < core.size) {
                            // å¤„ç†å¾—åˆ†
                            if (!gameState.powers.shield.active) {
                                const score = gameState.colorMode ? 
                                    Math.abs(gameState.projectileScores[getColorName(projectile.color)]) : // å˜è‰²æ¨¡å¼ä¸‹å¼ºåˆ¶æ­£æ•°
                                    gameState.projectileScores[getColorName(projectile.color)];
                                if (gameState.powers.double.active) {
                                    gameState.score += score * 2;
                                    showScoreEffect(score * 2, core.x, core.y); // æ˜¾ç¤ºåŒå€åˆ†æ•°æ•ˆæœ
                                } else {
                                    gameState.score += score;
                                    showScoreEffect(score, core.x, core.y); // æ˜¾ç¤ºæ™®é€šåˆ†æ•°æ•ˆæœ
                                }
                                // æ›´æ–°ç‰¹æ•ˆçŠ¶æ€
                                updateEffects(score, projectile.color);
                            }

                            // å¤„ç†ä¼¤å®³
                            if (projectile.color === '#ff0000' && !gameState.powers.shield.active && !gameState.powers.invincible.active && !gameState.colorMode) {
                                const damage = gameState.powers.double.active ? 2 : 1;
                                gameState.health -= damage;
                                core.size += 5 * damage;
                            }

                            projectilesToRemove.add(i);
                            break;
                        }
                    }
                }

                // æ£€æŸ¥æ˜¯å¦è¶…å‡ºå±å¹•
                if (projectile.x < -50 || projectile.x > canvas.width + 50 ||
                    projectile.y < -50 || projectile.y > canvas.height + 50) {
                    projectilesToRemove.add(i);
                }
            }

            // ä»åå‘å‰ç§»é™¤æŠ•å°„ä½“
            const sortedIndices = Array.from(projectilesToRemove).sort((a, b) => b - a);
            for (const index of sortedIndices) {
                gameState.projectiles.splice(index, 1);
            }

            // æ›´æ–°æ¸¸æˆæ—¶é—´
            gameState.time += deltaTime;

            // æ£€æŸ¥æ¸¸æˆæ˜¯å¦ç»“æŸ
            if (gameState.health <= 0) {
                endGame();
            }
        }

        // æ›´æ–°æŠ•å°„ä½“åˆ†æ•°
        function updateProjectileScores() {
            const colors = ['red', 'green', 'blue', 'yellow', 'purple', 'black'];
            colors.forEach(color => {
                const sign = gameState.colorMode ? 1 : (Math.random() < 0.5 ? 1 : -1);
                const value = Math.floor(Math.random() * 11); // 0-10
                gameState.projectileScores[color] = sign * value;
                
                // æ›´æ–°UIæ˜¾ç¤º
                const scoreElement = document.getElementById(color + 'Score');
                if (scoreElement) {
                    scoreElement.textContent = sign * value;
                }
            });
        }

        // è·å–é¢œè‰²åç§°
        function getColorName(color) {
            const colorMap = {
                '#ff0000': 'red',
                '#00ff00': 'green',
                '#0000ff': 'blue',
                '#ffff00': 'yellow',
                '#800080': 'purple',
                '#000000': 'black'
            };
            return colorMap[color] || 'red';
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(time) {
            // å°†æ—¶é—´è½¬æ¢ä¸ºç§’æ•°ï¼Œå‘ä¸‹å–æ•´
            const totalSeconds = Math.floor(time);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // æ›´æ–°é“å…·çŠ¶æ€æ˜¾ç¤º
        function updatePowerStatus() {
            Object.keys(gameState.powers).forEach(power => {
                const status = document.getElementById(power + 'Status');
                const cooldown = document.getElementById(power + 'Cooldown');
                
                if (gameState.powers[power].active) {
                    status.className = 'power-indicator active';
                    cooldown.textContent = 'æ¿€æ´»ä¸­';
                } else if (gameState.powers[power].cooldown > 0) {
                    status.className = 'power-indicator cooldown';
                    cooldown.textContent = `${gameState.powers[power].cooldown.toFixed(1)}s (${gameState.powers[power].uses}æ¬¡)`;
                } else {
                    status.className = 'power-indicator ready';
                    cooldown.textContent = `å°±ç»ª (${gameState.powers[power].uses}æ¬¡)`;
                }
            });
        }

        // æ›´æ–°é“å…·å†·å´æ—¶é—´
        function updatePowerCooldowns() {
            Object.keys(gameState.powers).forEach(power => {
                if (gameState.powers[power].cooldown > 0) {
                    gameState.powers[power].cooldown -= 0.1;
                }
            });
        }

        // æ¸²æŸ“æ¸¸æˆ
        function renderGame() {
            // æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // ç»˜åˆ¶èƒŒæ™¯
            if (gameState.useCustomBg) {
                // ä½¿ç”¨æµ…ç°è‰²èƒŒæ™¯
                ctx.fillStyle = '#f0f0f0';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            } else {
                // ä½¿ç”¨åŠ¨æ€èƒŒæ™¯å›¾ç‰‡
                if (gameState.backgroundImage.complete) {
                    ctx.drawImage(gameState.backgroundImage, 0, 0, canvas.width, canvas.height);
                }
            }

            // æ¸²æŸ“æŠ•å°„ä½“
            gameState.projectiles.forEach(projectile => {
                ctx.beginPath();
                ctx.arc(projectile.x, projectile.y, projectile.size, 0, Math.PI * 2);
                ctx.fillStyle = projectile.color;
                ctx.fill();
                ctx.closePath();
            });

            // æ¸²æŸ“æ ¸å¿ƒ
            if (gameState.cores && gameState.cores.length > 0) {
                gameState.cores.forEach(core => {
                    // ç»˜åˆ¶æ ¸å¿ƒå¤–åœˆ
                    ctx.beginPath();
                    ctx.arc(core.x, core.y, core.size, 0, Math.PI * 2);
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                    ctx.fill();
                    ctx.closePath();

                    // ç»˜åˆ¶æ ¸å¿ƒä¸­åœˆ
                    ctx.beginPath();
                    ctx.arc(core.x, core.y, core.size * 0.7, 0, Math.PI * 2);
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
                    ctx.fill();
                    ctx.closePath();

                    // ç»˜åˆ¶æ ¸å¿ƒå†…åœˆ
                    ctx.beginPath();
                    ctx.arc(core.x, core.y, core.size * 0.4, 0, Math.PI * 2);
                    ctx.fillStyle = '#ffffff';
                    ctx.fill();
                    ctx.closePath();

                    // ç»˜åˆ¶æ ¸å¿ƒè¾¹æ¡†
                    ctx.beginPath();
                    ctx.arc(core.x, core.y, core.size, 0, Math.PI * 2);
                    ctx.strokeStyle = '#000000';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    ctx.closePath();

                    // å¦‚æœæœ‰æŠ¤ç›¾æ•ˆæœï¼Œç»˜åˆ¶æŠ¤ç›¾å…‰ç¯
                    if (gameState.powers.shield.active) {
                        ctx.beginPath();
                        ctx.arc(core.x, core.y, core.size + 10, 0, Math.PI * 2);
                        ctx.strokeStyle = 'rgba(76, 175, 80, 0.5)';
                        ctx.lineWidth = 3;
                        ctx.stroke();
                        ctx.closePath();
                    }

                    // å¦‚æœæœ‰æ— æ•Œæ•ˆæœï¼Œç»˜åˆ¶æ— æ•Œå…‰ç¯
                    if (gameState.powers.invincible.active) {
                        ctx.beginPath();
                        ctx.arc(core.x, core.y, core.size + 15, 0, Math.PI * 2);
                        ctx.strokeStyle = 'rgba(255, 215, 0, 0.5)';
                        ctx.lineWidth = 3;
                        ctx.stroke();
                        ctx.closePath();
                    }
                });
            }

            // æ›´æ–°UI
            document.getElementById('score').textContent = gameState.score;
            document.getElementById('health').textContent = gameState.health;
            document.getElementById('speed').textContent = gameState.speed.toFixed(1) + 'x';
            document.getElementById('time').textContent = formatTime(gameState.time);

            // æ›´æ–°é“å…·çŠ¶æ€
            updatePowerStatus();
        }

        // æ¿€æ´»æŠ¤ç›¾
        function activateShield() {
            if (gameState.powers.shield.uses > 0 && gameState.powers.shield.cooldown <= 0) {
                gameState.powers.shield.active = true;
                gameState.powers.shield.uses--;
                gameState.powers.shield.cooldown = 15; // 15ç§’å†·å´
                setTimeout(() => {
                    gameState.powers.shield.active = false;
                }, 5000); // 5ç§’æŒç»­æ—¶é—´
            }
        }

        // æ¿€æ´»å†»ç»“
        function activateFreeze() {
            if (gameState.powers.freeze.uses > 0 && gameState.powers.freeze.cooldown <= 0) {
                gameState.powers.freeze.active = true;
                gameState.powers.freeze.uses--;
                gameState.powers.freeze.cooldown = 15; // 15ç§’å†·å´
                setTimeout(() => {
                    gameState.powers.freeze.active = false;
                }, 5000); // 5ç§’æŒç»­æ—¶é—´
            }
        }

        // æ¿€æ´»åŒå€åˆ†æ•°
        function activateDoubleScore() {
            if (gameState.powers.double.uses > 0 && gameState.powers.double.cooldown <= 0) {
                gameState.powers.double.active = true;
                gameState.powers.double.uses--;
                gameState.powers.double.cooldown = 20; // 20ç§’å†·å´
                setTimeout(() => {
                    gameState.powers.double.active = false;
                }, 8000); // 8ç§’æŒç»­æ—¶é—´
            }
        }

        // æ¿€æ´»æ— æ•Œ
        function activateInvincible() {
            if (gameState.powers.invincible.uses > 0 && gameState.powers.invincible.cooldown <= 0) {
                gameState.powers.invincible.active = true;
                gameState.powers.invincible.uses--;
                gameState.powers.invincible.cooldown = 30; // 30ç§’å†·å´
                setTimeout(() => {
                    gameState.powers.invincible.active = false;
                }, 3000); // 3ç§’æŒç»­æ—¶é—´
            }
        }

        // ç»“æŸæ¸¸æˆ
        function endGame() {
            if (!gameState.isGameRunning) return; // é˜²æ­¢é‡å¤è°ƒç”¨
            
            gameState.isGameRunning = false;
            
            // è·å–ç©å®¶ä¿¡æ¯
            const playerNickname = localStorage.getItem('playerNickname');
            if (!playerNickname) {
                console.error('æœªæ‰¾åˆ°ç©å®¶æ˜µç§°');
                window.location.href = 'Start.html';
                return;
            }
            
            // ä¿å­˜æ¸¸æˆæ•°æ®
            const finalScore = Math.floor(gameState.score || 0);
            const gameTime = Math.max(0, parseFloat(gameState.time || 0));
            
            console.log('ä¿å­˜æ¸¸æˆæ•°æ®ï¼š', {
                nickname: playerNickname,
                score: finalScore,
                time: gameTime
            });
            
            // ä¿å­˜æœ€ç»ˆå¾—åˆ†å’Œæ—¶é—´
            localStorage.setItem('finalScore', finalScore.toString());
            localStorage.setItem('gameTime', gameTime.toString());
            
            // æ›´æ–°æœ€é«˜åˆ†
            let highScores = [];
            try {
                const savedScores = localStorage.getItem('highScores');
                console.log('è¯»å–åˆ°çš„å†å²è®°å½•ï¼š', savedScores);
                
                // å¦‚æœå­˜åœ¨æ—§æ•°æ®ï¼Œå°è¯•è§£æ
                if (savedScores) {
                    try {
                        highScores = JSON.parse(savedScores);
                        // æ£€æŸ¥æ˜¯å¦æ˜¯æ—§æ ¼å¼ï¼ˆæ•°å­—æ•°ç»„ï¼‰
                        if (Array.isArray(highScores) && highScores.length > 0 && typeof highScores[0] === 'number') {
                            console.log('æ£€æµ‹åˆ°æ—§æ ¼å¼æ•°æ®ï¼Œé‡ç½®ä¸ºç©ºæ•°ç»„');
                            highScores = [];
                        }
                    } catch (error) {
                        console.error('è§£æå†å²è®°å½•å¤±è´¥ï¼š', error);
                        highScores = [];
                    }
                }
                
                // ç¡®ä¿highScoresæ˜¯æ•°ç»„
                if (!Array.isArray(highScores)) {
                    console.log('highScoresä¸æ˜¯æ•°ç»„ï¼Œé‡ç½®ä¸ºç©ºæ•°ç»„');
                    highScores = [];
                }
            } catch (error) {
                console.error('è¯»å–æœ€é«˜åˆ†å¤±è´¥ï¼š', error);
                highScores = [];
            }
            
            // æ·»åŠ å½“å‰æ¸¸æˆè®°å½•
            const currentScore = {
                nickname: playerNickname,
                score: finalScore,
                time: gameTime,
                timestamp: Date.now()
            };
            
            console.log('æ·»åŠ æ–°è®°å½•ï¼š', currentScore);
            
            // ä¿å­˜æ‰€æœ‰è®°å½•
            highScores.push(currentScore);
            
            // æŒ‰æ—¶é—´æˆ³æ’åºï¼ˆä»æ–°åˆ°æ—§ï¼‰
            highScores.sort((a, b) => b.timestamp - a.timestamp);
            
            // åªä¿ç•™æœ€æ–°çš„5æ¡è®°å½•
            highScores = highScores.slice(0, 5);
            
            // ä¿å­˜æ›´æ–°åçš„æ’è¡Œæ¦œ
            try {
                const scoresString = JSON.stringify(highScores);
                console.log('å‡†å¤‡ä¿å­˜çš„æ•°æ®ï¼š', scoresString);
                localStorage.setItem('highScores', scoresString);
                console.log('ä¿å­˜æœ€é«˜åˆ†æˆåŠŸï¼š', highScores);
            } catch (error) {
                console.error('ä¿å­˜æœ€é«˜åˆ†å¤±è´¥ï¼š', error);
            }
            
            // è·³è½¬åˆ°ç»“ç®—é¡µé¢
            window.location.href = 'Gameover.html';
        }

        // æ›´æ–°ç‰¹æ•ˆçŠ¶æ€
        function updateEffects(score, projectileColor) {
            const effects = gameState.effects;
            
            // æ›´æ–°ç‰¹æ•ˆé¢æ¿æ˜¾ç¤º
            document.getElementById('effectsPanel').style.display = 'block';
            
            // çµæ•ç‰¹æ•ˆï¼šè¿ç»­èº²é¿çº¢è‰²æŠ•å°„ç‰©
            if (projectileColor === '#ff0000') {
                effects.redDodgeCount++;
                document.getElementById('effectSensitive').textContent = `çµæ•: ${effects.redDodgeCount}/10`;
                if (effects.redDodgeCount >= 10) {
                    triggerEffect('sensitive');
                }
            } else {
                effects.redDodgeCount = 0;
                document.getElementById('effectSensitive').textContent = `çµæ•: ${effects.redDodgeCount}/10`;
            }

            // ç²¾å‡†ç‰¹æ•ˆï¼šè¿ç»­å¾—åˆ†
            if (score > 0) {
                effects.consecutiveScore++;
                effects.lastPositiveScore = gameState.score;
                document.getElementById('effectPrecise').textContent = `ç²¾å‡†: ${effects.consecutiveScore}/20`;
                if (effects.consecutiveScore >= 20) {
                    triggerEffect('precise');
                }
            } else {
                effects.consecutiveScore = 0;
                document.getElementById('effectPrecise').textContent = `ç²¾å‡†: ${effects.consecutiveScore}/20`;
            }

            // é›†ä¸­æ³¨æ„ç‰¹æ•ˆï¼šç´¯è®¡å‡åˆ†
            if (score < 0) {
                effects.negativeScoreTotal += Math.abs(score);
                document.getElementById('effectFocused').textContent = `é›†ä¸­æ³¨æ„: ${effects.negativeScoreTotal}/30`;
                if (effects.negativeScoreTotal >= 30 && gameState.score <= effects.lastPositiveScore) {
                    triggerEffect('focused');
                }
            }
        }

        // è§¦å‘ç‰¹æ•ˆ
        function triggerEffect(type) {
            const effectElement = document.getElementById(`effect${type.charAt(0).toUpperCase() + type.slice(1)}`);
            effectElement.classList.add('active');
            
            switch(type) {
                case 'sensitive':
                    // è·å¾—æ— æ•Œ+1
                    gameState.powers.invincible.uses++;
                    showEffectMessage('è·å¾—æ— æ•Œ+1');
                    break;
                case 'precise':
                    // è·å¾—æŠ¤ç›¾+1
                    gameState.powers.shield.uses++;
                    showEffectMessage('è·å¾—æŠ¤ç›¾+1');
                    break;
                case 'focused':
                    // æš‚æ— å¥–åŠ±
                    showEffectMessage('é›†ä¸­æ³¨æ„ï¼');
                    break;
            }

            // é‡ç½®ç›¸å…³è®¡æ•°
            switch(type) {
                case 'sensitive':
                    gameState.effects.redDodgeCount = 0;
                    break;
                case 'precise':
                    gameState.effects.consecutiveScore = 0;
                    break;
                case 'focused':
                    gameState.effects.negativeScoreTotal = 0;
                    break;
            }

            // 3ç§’åç§»é™¤ç‰¹æ•ˆåŠ¨ç”»
            setTimeout(() => {
                effectElement.classList.remove('active');
            }, 3000);
        }

        // æ˜¾ç¤ºç‰¹æ•ˆæ¶ˆæ¯
        function showEffectMessage(message) {
            const messageElement = document.createElement('div');
            messageElement.style.cssText = `
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0, 0, 0, 0.8);
                color: #4CAF50;
                padding: 15px 30px;
                border-radius: 5px;
                font-size: 24px;
                z-index: 1000;
                animation: fadeOut 2s forwards;
            `;
            messageElement.textContent = message;
            document.body.appendChild(messageElement);

            // 2ç§’åç§»é™¤æ¶ˆæ¯
            setTimeout(() => {
                messageElement.remove();
            }, 2000);
        }

        // æ·»åŠ æ¶ˆæ¯åŠ¨ç”»æ ·å¼
        const messageStyle = document.createElement('style');
        messageStyle.textContent = `
            @keyframes fadeOut {
                0% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
                50% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
                100% { opacity: 0; transform: translate(-50%, -50%) scale(1); }
            }
        `;
        document.head.appendChild(messageStyle);

        // æ·»åŠ åˆ†æ•°å˜åŒ–ç‰¹æ•ˆæ˜¾ç¤ºå‡½æ•°
        function showScoreEffect(score, x, y) {
            const effectElement = document.createElement('div');
            const isPositive = score > 0;
            const prefix = isPositive ? '+' : '';
            
            effectElement.style.cssText = `
                position: absolute;
                left: ${x}px;
                top: ${y}px;
                color: ${isPositive ? '#4CAF50' : '#ff0000'};
                font-size: 20px;
                font-weight: bold;
                pointer-events: none;
                z-index: 1000;
                text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
                animation: scoreFloat 1s ease-out forwards;
            `;
            
            effectElement.textContent = `${prefix}${score}`;
            document.body.appendChild(effectElement);

            // 1ç§’åç§»é™¤ç‰¹æ•ˆ
            setTimeout(() => {
                effectElement.remove();
            }, 1000);
        }

        // æ·»åŠ åˆ†æ•°æµ®åŠ¨åŠ¨ç”»æ ·å¼
        const scoreAnimationStyle = document.createElement('style');
        scoreAnimationStyle.textContent = `
            @keyframes scoreFloat {
                0% {
                    opacity: 1;
                    transform: translate(-50%, -50%) scale(1);
                }
                50% {
                    opacity: 0.8;
                    transform: translate(-50%, -100%) scale(1.2);
                }
                100% {
                    opacity: 0;
                    transform: translate(-50%, -150%) scale(1);
                }
            }
        `;
        document.head.appendChild(scoreAnimationStyle);

        // æ›´æ–°æ¸¸æˆæ¨¡å¼ä¿¡æ¯
        function updateGameModeInfo() {
            const modeElement = document.getElementById('gameMode');
            const featureElement = document.getElementById('coreFeature');
            const multiplierElement = document.getElementById('scoreMultiplier');

            switch(gameState.mode) {
                case 'EASY':
                    modeElement.textContent = 'ç®€å•æ¨¡å¼';
                    featureElement.textContent = 'å›ºå®šå¤§å°æ ¸å¿ƒ';
                    multiplierElement.textContent = '1.0x';
                    break;
                case 'MEDIUM':
                    modeElement.textContent = 'ä¸­ç­‰æ¨¡å¼';
                    featureElement.textContent = 'è´ªåƒè›‡æ ¸å¿ƒï¼ˆé•¿åº¦éšå¾—åˆ†å¢åŠ ï¼‰';
                    multiplierElement.textContent = '1.5x';
                    break;
                case 'HARD':
                    modeElement.textContent = 'å›°éš¾æ¨¡å¼';
                    featureElement.textContent = 'å‘¼å¸æ ¸å¿ƒï¼ˆå¤§å°å‘¨æœŸæ€§å˜åŒ–ï¼‰';
                    multiplierElement.textContent = '2.0x';
                    break;
            }
        }

        // ä¿®æ”¹ç§»åŠ¨ç«¯æ§åˆ¶æ”¯æŒ
        function setupMobileControls() {
            const canvas = document.getElementById('gameCanvas');
            let isDragging = false;
            let lastTouchX = 0;
            let lastTouchY = 0;

            // å¤„ç†è§¦æ‘¸å¼€å§‹
            canvas.addEventListener('touchstart', function(e) {
                e.preventDefault();
                isDragging = true;
                const touch = e.touches[0];
                const rect = canvas.getBoundingClientRect();
                lastTouchX = touch.clientX - rect.left;
                lastTouchY = touch.clientY - rect.top;
                
                // ç›´æ¥æ›´æ–°æ ¸å¿ƒä½ç½®
                if (gameState.cores && gameState.cores.length > 0) {
                    gameState.cores.forEach(core => {
                        core.x = Math.max(core.size, Math.min(canvas.width - core.size, lastTouchX));
                        core.y = Math.max(core.size, Math.min(canvas.height - core.size, lastTouchY));
                        core.targetX = core.x;
                        core.targetY = core.y;
                    });
                }
            }, { passive: false });

            // å¤„ç†è§¦æ‘¸ç§»åŠ¨
            canvas.addEventListener('touchmove', function(e) {
                e.preventDefault();
                if (!isDragging) return;

                const touch = e.touches[0];
                const rect = canvas.getBoundingClientRect();
                const currentX = touch.clientX - rect.left;
                const currentY = touch.clientY - rect.top;

                // ç›´æ¥æ›´æ–°æ ¸å¿ƒä½ç½®
                if (gameState.cores && gameState.cores.length > 0) {
                    gameState.cores.forEach(core => {
                        core.x = Math.max(core.size, Math.min(canvas.width - core.size, currentX));
                        core.y = Math.max(core.size, Math.min(canvas.height - core.size, currentY));
                        core.targetX = core.x;
                        core.targetY = core.y;
                    });
                }

                lastTouchX = currentX;
                lastTouchY = currentY;
            }, { passive: false });

            // å¤„ç†è§¦æ‘¸ç»“æŸ
            canvas.addEventListener('touchend', function(e) {
                e.preventDefault();
                isDragging = false;
            }, { passive: false });

            // å¤„ç†è§¦æ‘¸å–æ¶ˆ
            canvas.addEventListener('touchcancel', function(e) {
                e.preventDefault();
                isDragging = false;
            }, { passive: false });

            // è®¾ç½®ç§»åŠ¨ç«¯æŒ‰é’®
            const shieldButton = document.getElementById('shieldButton');
            const freezeButton = document.getElementById('freezeButton');
            const doubleButton = document.getElementById('doubleButton');
            const invincibleButton = document.getElementById('invincibleButton');

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            function updateButtonStates() {
                shieldButton.style.opacity = (gameState.powers.shield.uses > 0 && gameState.powers.shield.cooldown <= 0) ? '1' : '0.5';
                freezeButton.style.opacity = (gameState.powers.freeze.uses > 0 && gameState.powers.freeze.cooldown <= 0) ? '1' : '0.5';
                doubleButton.style.opacity = (gameState.powers.double.uses > 0 && gameState.powers.double.cooldown <= 0) ? '1' : '0.5';
                invincibleButton.style.opacity = (gameState.powers.invincible.uses > 0 && gameState.powers.invincible.cooldown <= 0) ? '1' : '0.5';
            }

            // å®šæœŸæ›´æ–°æŒ‰é’®çŠ¶æ€
            setInterval(updateButtonStates, 100);

            // è®¾ç½®æŒ‰é’®äº‹ä»¶
            shieldButton.addEventListener('touchstart', (e) => {
                e.preventDefault();
                if (gameState.powers.shield.uses > 0 && gameState.powers.shield.cooldown <= 0) {
                    activateShield();
                    updateButtonStates();
                }
            });

            freezeButton.addEventListener('touchstart', (e) => {
                e.preventDefault();
                if (gameState.powers.freeze.uses > 0 && gameState.powers.freeze.cooldown <= 0) {
                    activateFreeze();
                    updateButtonStates();
                }
            });

            doubleButton.addEventListener('touchstart', (e) => {
                e.preventDefault();
                if (gameState.powers.double.uses > 0 && gameState.powers.double.cooldown <= 0) {
                    activateDoubleScore();
                    updateButtonStates();
                }
            });

            invincibleButton.addEventListener('touchstart', (e) => {
                e.preventDefault();
                if (gameState.powers.invincible.uses > 0 && gameState.powers.invincible.cooldown <= 0) {
                    activateInvincible();
                    updateButtonStates();
                }
            });

            // è®¾ç½®ç§»åŠ¨ç«¯åŠŸèƒ½æŒ‰é’®
            document.getElementById('bgToggleMobile').addEventListener('touchstart', (e) => {
                e.preventDefault();
                gameState.useCustomBg = !gameState.useCustomBg;
                this.classList.toggle('active');
                this.textContent = gameState.useCustomBg ? 'åˆ‡æ¢èƒŒæ™¯' : 'æ¢å¤ç°è‰²';
            });

            document.getElementById('inertiaToggleMobile').addEventListener('touchstart', (e) => {
                e.preventDefault();
                gameState.inertiaEnabled = !gameState.inertiaEnabled;
                this.classList.toggle('active');
                this.textContent = gameState.inertiaEnabled ? 'æƒ¯æ€§' : 'æ— æƒ¯æ€§';
                gameState.coreSmoothing = gameState.inertiaEnabled ? 0.15 : 1;
            });

            document.getElementById('colorToggleMobile').addEventListener('touchstart', (e) => {
                e.preventDefault();
                gameState.colorMode = !gameState.colorMode;
                this.classList.toggle('active');
                this.textContent = gameState.colorMode ? 'æ¢å¤åŸè‰²' : 'å˜è‰²';
            });

            // è®¾ç½®ç§»åŠ¨ç«¯æ¸¸æˆæ§åˆ¶æŒ‰é’®
            document.getElementById('restartButton').addEventListener('touchstart', (e) => {
                e.preventDefault();
                gameState.isGameRunning = false;
                window.location.reload();
            });

            document.getElementById('exitButton').addEventListener('touchstart', (e) => {
                e.preventDefault();
                endGame();
            });
        }

        // æ£€æµ‹è®¾å¤‡ç±»å‹
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–æ¸¸æˆ
        window.addEventListener('load', function() {
            console.log('Page loaded, setting up game...');
            setupEventListeners();
            initGame();

            // åˆå§‹åŒ–éŸ³ä¹æ§åˆ¶
            const musicToggle = document.getElementById('musicToggle');
            let bgMusic;
            
            // é¢„åŠ è½½éŸ³é¢‘
            function preloadAudio() {
                return new Promise((resolve, reject) => {
                    bgMusic = new Audio('music/beethoven_virus.mp3');
                    bgMusic.loop = true;
                    
                    // è®¾ç½®éŸ³é¢‘åŠ è½½äº‹ä»¶
                    bgMusic.addEventListener('canplaythrough', () => {
                        console.log('éŸ³é¢‘åŠ è½½å®Œæˆ');
                        resolve(bgMusic);
                    });
                    
                    bgMusic.addEventListener('error', (e) => {
                        console.error('éŸ³é¢‘åŠ è½½å¤±è´¥:', e);
                        reject(e);
                    });
                    
                    // å¼€å§‹åŠ è½½éŸ³é¢‘
                    bgMusic.load();
                });
            }

            // åˆå§‹åŒ–éŸ³é¢‘
            preloadAudio().then(audio => {
                // ä»sessionStorageè·å–æ’­æ”¾ä½ç½®
                const musicData = sessionStorage.getItem('bgMusic');
                if (musicData) {
                    audio.currentTime = parseFloat(musicData);
                }
                
                // ä»localStorageè¯»å–éŸ³ä¹çŠ¶æ€
                const isMusicMuted = localStorage.getItem('isMusicMuted') === 'true';
                if (!isMusicMuted) {
                    audio.play().catch(error => {
                        console.log('è‡ªåŠ¨æ’­æ”¾è¢«é˜»æ­¢ï¼Œç­‰å¾…ç”¨æˆ·äº¤äº’');
                    });
                } else {
                    musicToggle.classList.add('muted');
                }

                // éŸ³ä¹æ§åˆ¶æŒ‰é’®ç‚¹å‡»äº‹ä»¶
                musicToggle.addEventListener('click', () => {
                    if (audio.paused) {
                        audio.play();
                        musicToggle.classList.remove('muted');
                        localStorage.setItem('isMusicMuted', 'false');
                    } else {
                        audio.pause();
                        musicToggle.classList.add('muted');
                        localStorage.setItem('isMusicMuted', 'true');
                    }
                });

                // å®šæœŸä¿å­˜éŸ³ä¹æ’­æ”¾ä½ç½®
                setInterval(() => {
                    if (!audio.paused) {
                        sessionStorage.setItem('bgMusic', audio.currentTime);
                    }
                }, 1000);
            }).catch(error => {
                console.error('éŸ³é¢‘åˆå§‹åŒ–å¤±è´¥:', error);
            });
        });

        // æ·»åŠ çª—å£å¤§å°æ”¹å˜äº‹ä»¶ç›‘å¬
        window.addEventListener('resize', resizeCanvas);
        window.addEventListener('orientationchange', resizeCanvas);
    </script>
</body>
</html> 